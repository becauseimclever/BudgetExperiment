@* EditRecurringForm.razor - Form for editing existing recurring transactions *@

<form @onsubmit="HandleSubmit">
    <div class="form-group">
        <label for="description" class="form-label">Description:</label>
        <input id="description"
               type="text"
               class="form-control"
               @bind="Model.Description"
               @bind:event="oninput"
               placeholder="Enter description" />
    </div>

    <div class="form-row">
        <div class="form-group">
            <label for="amount" class="form-label">Amount:</label>
            <input id="amount"
                   type="number"
                   class="form-control"
                   step="0.01"
                   @bind="amountInput"
                   placeholder="0.00" />
        </div>
        <div class="form-group form-group-sm">
            <label for="currency" class="form-label">Currency:</label>
            <select id="currency" class="form-control" @bind="currencyInput">
                <option value="USD">USD</option>
            </select>
        </div>
    </div>

    <div class="form-group">
        <label for="endDate" class="form-label">End Date (optional):</label>
        <input id="endDate"
               type="date"
               class="form-control"
               @bind="endDateInput" />
        <span class="form-text">Leave empty for no end date</span>
    </div>

    <div class="form-group">
        <label for="category" class="form-label">Category (optional):</label>
        <input id="category"
               type="text"
               class="form-control"
               @bind="Model.Category"
               placeholder="e.g., Bills, Income, Subscription" />
    </div>

    <div class="form-actions form-actions-right">
        <button type="button" class="btn btn-secondary" @onclick="HandleCancel" disabled="@IsSubmitting">
            Cancel
        </button>
        <button type="submit" class="btn btn-primary" disabled="@IsSubmitting">
            @if (IsSubmitting)
            {
                <span>Saving...</span>
            }
            else
            {
                <span>Save Changes</span>
            }
        </button>
    </div>
</form>

@code {
    /// <summary>
    /// Gets or sets the update model.
    /// </summary>
    [Parameter]
    public RecurringTransactionUpdateDto Model { get; set; } = new();

    /// <summary>
    /// Gets or sets the callback when the form is submitted.
    /// </summary>
    [Parameter]
    public EventCallback<RecurringTransactionUpdateDto> OnSubmit { get; set; }

    /// <summary>
    /// Gets or sets the callback when cancel is clicked.
    /// </summary>
    [Parameter]
    public EventCallback OnCancel { get; set; }

    /// <summary>
    /// Gets or sets a value indicating whether the form is submitting.
    /// </summary>
    [Parameter]
    public bool IsSubmitting { get; set; }

    private DateTime? endDateInput;
    private decimal amountInput;
    private string currencyInput = "USD";

    protected override void OnParametersSet()
    {
        if (Model.EndDate.HasValue)
        {
            endDateInput = Model.EndDate.Value.ToDateTime(TimeOnly.MinValue);
        }
        else
        {
            endDateInput = null;
        }

        amountInput = Model.Amount.Amount;
        currencyInput = Model.Amount.Currency;
    }

    private async Task HandleSubmit()
    {
        // Convert DateTime input to DateOnly
        Model.EndDate = endDateInput.HasValue ? DateOnly.FromDateTime(endDateInput.Value) : null;
        Model.Amount = new MoneyDto { Amount = amountInput, Currency = currencyInput };

        await OnSubmit.InvokeAsync(Model);
    }

    private async Task HandleCancel()
    {
        await OnCancel.InvokeAsync();
    }
}
