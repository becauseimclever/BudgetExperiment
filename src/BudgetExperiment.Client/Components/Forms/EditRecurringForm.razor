@* EditRecurringForm.razor - Form for editing existing recurring transactions *@

<form @onsubmit="HandleSubmit">
    <FormField Label="Description:" InputId="description">
        <input id="description"
               type="text"
               class="form-control"
               @bind="Model.Description"
               @bind:event="oninput"
               placeholder="Enter description" />
    </FormField>

    <div class="form-row">
        <div class="form-group">
            <label for="amount" class="form-label">Amount:</label>
            <input id="amount"
                   type="number"
                   class="form-control"
                   step="0.01"
                   @bind="amountInput"
                   placeholder="0.00" />
        </div>
        <div class="form-group form-group-sm">
            <label for="currency" class="form-label">Currency:</label>
            <select id="currency" class="form-control" @bind="currencyInput">
                <option value="USD">USD</option>
            </select>
        </div>
    </div>

    <FormField Label="End Date (optional):" InputId="endDate" HelpText="Leave empty for no end date">
        <input id="endDate"
               type="date"
               class="form-control"
               @bind="endDateInput" />
    </FormField>

    <FormField Label="Category:" InputId="editRecCategory">
        <select id="editRecCategory" class="form-control" @bind="Model.CategoryId">
            <option value="">None</option>
            @foreach (var category in Categories.Where(c => c.IsActive))
            {
                <option value="@category.Id">@category.Name</option>
            }
        </select>
    </FormField>

    <div class="form-actions form-actions-right">
        <Button Variant="ButtonVariant.Secondary" OnClick="HandleCancel" IsDisabled="@IsSubmitting" type="button">
            Cancel
        </Button>
        <Button Variant="ButtonVariant.Primary" IsLoading="@IsSubmitting" IsDisabled="@IsSubmitting" type="submit">
            Save Changes
        </Button>
    </div>
</form>

@code {
    /// <summary>
    /// Gets or sets the update model.
    /// </summary>
    [Parameter]
    public RecurringTransactionUpdateDto Model { get; set; } = new();

    /// <summary>
    /// Gets or sets the list of budget categories for the dropdown.
    /// </summary>
    [Parameter]
    public IReadOnlyList<BudgetCategoryDto> Categories { get; set; } = Array.Empty<BudgetCategoryDto>();

    /// <summary>
    /// Gets or sets the callback when the form is submitted.
    /// </summary>
    [Parameter]
    public EventCallback<RecurringTransactionUpdateDto> OnSubmit { get; set; }

    /// <summary>
    /// Gets or sets the callback when cancel is clicked.
    /// </summary>
    [Parameter]
    public EventCallback OnCancel { get; set; }

    /// <summary>
    /// Gets or sets a value indicating whether the form is submitting.
    /// </summary>
    [Parameter]
    public bool IsSubmitting { get; set; }

    private DateTime? endDateInput;
    private decimal amountInput;
    private string currencyInput = "USD";

    protected override void OnParametersSet()
    {
        if (Model.EndDate.HasValue)
        {
            endDateInput = Model.EndDate.Value.ToDateTime(TimeOnly.MinValue);
        }
        else
        {
            endDateInput = null;
        }

        amountInput = Model.Amount.Amount;
        currencyInput = Model.Amount.Currency;
    }

    private async Task HandleSubmit()
    {
        // Convert DateTime input to DateOnly
        Model.EndDate = endDateInput.HasValue ? DateOnly.FromDateTime(endDateInput.Value) : null;
        Model.Amount = new MoneyDto { Amount = amountInput, Currency = currencyInput };

        await OnSubmit.InvokeAsync(Model);
    }

    private async Task HandleCancel()
    {
        await OnCancel.InvokeAsync();
    }
}
