@* EditRecurringTransferForm.razor - Form for editing existing recurring transfers *@

<form @onsubmit="HandleSubmit">
    <FormField Label="Description:" InputId="description">
        <input id="description"
               type="text"
               class="form-control"
               @bind="Model.Description"
               @bind:event="oninput"
               placeholder="Enter description" />
    </FormField>

    <div class="form-row">
        <div class="form-group">
            <label for="amount">Amount:</label>
            <input id="amount"
                   type="number"
                   step="0.01"
                   min="0.01"
                   @bind="amountInput"
                   placeholder="0.00" />
        </div>
        <div class="form-group form-group-small">
            <label for="currency">Currency:</label>
            <select id="currency" @bind="currencyInput">
                <option value="USD">USD</option>
            </select>
        </div>
    </div>

    <FormField Label="Frequency:" InputId="frequency">
        <select id="frequency" class="form-control" @bind="Model.Frequency" @bind:after="OnFrequencyChanged">
            <option value="Daily">Daily</option>
            <option value="Weekly">Weekly</option>
            <option value="BiWeekly">Bi-Weekly</option>
            <option value="Monthly">Monthly</option>
            <option value="Quarterly">Quarterly</option>
            <option value="Yearly">Yearly</option>
        </select>
    </FormField>

    @if (Model.Frequency == "Weekly" || Model.Frequency == "BiWeekly")
    {
        <FormField Label="Day of Week:" InputId="dayOfWeek">
            <select id="dayOfWeek" class="form-control" @bind="Model.DayOfWeek">
                <option value="Monday">Monday</option>
                <option value="Tuesday">Tuesday</option>
                <option value="Wednesday">Wednesday</option>
                <option value="Thursday">Thursday</option>
                <option value="Friday">Friday</option>
                <option value="Saturday">Saturday</option>
                <option value="Sunday">Sunday</option>
            </select>
        </FormField>
    }

    @if (Model.Frequency == "Monthly" || Model.Frequency == "Quarterly" || Model.Frequency == "Yearly")
    {
        <FormField Label="Day of Month:" InputId="dayOfMonth">
            <input id="dayOfMonth"
                   type="number"
                   class="form-control"
                   min="1"
                   max="31"
                   @bind="Model.DayOfMonth"
                   placeholder="1-31" />
        </FormField>
    }

    <FormField Label="End Date (optional):" InputId="endDate" HelpText="Leave empty for no end date">
        <input id="endDate"
               type="date"
               class="form-control"
               @bind="endDateInput" />
    </FormField>

    <div class="form-actions">
        <Button Variant="ButtonVariant.Primary" IsLoading="@IsSubmitting" IsDisabled="@IsSubmitting" type="submit">
            Save Changes
        </Button>
        <Button Variant="ButtonVariant.Secondary" OnClick="HandleCancel" IsDisabled="@IsSubmitting" type="button">
            Cancel
        </Button>
    </div>
</form>

@code {
    /// <summary>
    /// Gets or sets the update model.
    /// </summary>
    [Parameter]
    public RecurringTransferUpdateDto Model { get; set; } = new();

    /// <summary>
    /// Gets or sets the callback when the form is submitted.
    /// </summary>
    [Parameter]
    public EventCallback<RecurringTransferUpdateDto> OnSubmit { get; set; }

    /// <summary>
    /// Gets or sets the callback when cancel is clicked.
    /// </summary>
    [Parameter]
    public EventCallback OnCancel { get; set; }

    /// <summary>
    /// Gets or sets a value indicating whether the form is submitting.
    /// </summary>
    [Parameter]
    public bool IsSubmitting { get; set; }

    private DateTime? endDateInput;
    private decimal amountInput;
    private string currencyInput = "USD";

    /// <inheritdoc/>
    protected override void OnParametersSet()
    {
        if (Model.EndDate.HasValue)
        {
            endDateInput = Model.EndDate.Value.ToDateTime(TimeOnly.MinValue);
        }
        else
        {
            endDateInput = null;
        }

        amountInput = Model.Amount.Amount;
        currencyInput = Model.Amount.Currency;
    }

    private void OnFrequencyChanged()
    {
        // Set sensible defaults when frequency changes
        if (Model.Frequency == "Weekly" || Model.Frequency == "BiWeekly")
        {
            Model.DayOfWeek ??= "Monday";
            Model.DayOfMonth = null;
        }
        else if (Model.Frequency == "Monthly" || Model.Frequency == "Quarterly" || Model.Frequency == "Yearly")
        {
            Model.DayOfWeek = null;
        }
        else
        {
            Model.DayOfWeek = null;
            Model.DayOfMonth = null;
        }
    }

    private async Task HandleSubmit()
    {
        // Convert DateTime input to DateOnly
        Model.EndDate = endDateInput.HasValue ? DateOnly.FromDateTime(endDateInput.Value) : null;
        Model.Amount = new MoneyDto { Amount = amountInput, Currency = currencyInput };

        await OnSubmit.InvokeAsync(Model);
    }

    private async Task HandleCancel()
    {
        await OnCancel.InvokeAsync();
    }
}
