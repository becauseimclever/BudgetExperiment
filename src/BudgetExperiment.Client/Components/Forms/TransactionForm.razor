@* TransactionForm.razor - Reusable transaction create/edit form *@

<form @onsubmit="HandleSubmit">
    @if (ShowAccountSelector)
    {
        <FormField Label="Account:" InputId="txnAccount">
            <select id="txnAccount" class="form-control" @bind="Model.AccountId" required>
                <option value="">Select Account</option>
                @foreach (var account in Accounts)
                {
                    <option value="@account.Id">@account.Name</option>
                }
            </select>
        </FormField>
    }
    <FormField Label="Description:" InputId="txnDescription">
        <input id="txnDescription" 
               type="text"
               class="form-control"
               @bind="Model.Description" 
               @bind:event="oninput"
               placeholder="Enter description"
               required />
    </FormField>
    <FormField Label="Amount:" InputId="txnAmount" HelpText="Positive for income, negative for expenses">
        <input id="txnAmount" 
               type="number"
               class="form-control"
               step="0.01" 
               @bind="AmountValue" 
               placeholder="0.00"
               required />
    </FormField>
    <FormField Label="Category:" InputId="txnCategory">
        <select id="txnCategory" class="form-control" @bind="Model.CategoryId">
            <option value="">None</option>
            @foreach (var category in Categories.Where(c => c.IsActive))
            {
                <option value="@category.Id">@category.Name</option>
            }
        </select>
    </FormField>
    <FormField Label="Date:" InputId="txnDate">
        <input id="txnDate" 
               type="date"
               class="form-control"
               @bind="DateValue" 
               required />
    </FormField>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="form-error-box">
            <span class="form-error-box-icon"><Icon Name="alert-triangle" Size="16" Class="icon-warning" /></span>
            <span class="form-error-box-text">@ErrorMessage</span>
        </div>
    }

    <div class="form-actions form-actions-right">
        <Button Variant="ButtonVariant.Secondary" OnClick="HandleCancel" IsDisabled="@IsSubmitting" type="button">
            Cancel
        </Button>
        <Button Variant="ButtonVariant.Primary" IsLoading="@IsSubmitting" IsDisabled="@IsSubmitting" type="submit">
            @SubmitButtonText
        </Button>
    </div>
</form>

@code {
    /// <summary>
    /// Gets or sets the transaction model to edit.
    /// </summary>
    [Parameter]
    public TransactionCreateDto Model { get; set; } = new();

    /// <summary>
    /// Gets or sets the list of accounts for the dropdown.
    /// </summary>
    [Parameter]
    public IReadOnlyList<AccountDto> Accounts { get; set; } = Array.Empty<AccountDto>();

    /// <summary>
    /// Gets or sets the list of budget categories for the dropdown.
    /// </summary>
    [Parameter]
    public IReadOnlyList<BudgetCategoryDto> Categories { get; set; } = Array.Empty<BudgetCategoryDto>();

    /// <summary>
    /// Gets or sets a value indicating whether to show the account selector.
    /// </summary>
    [Parameter]
    public bool ShowAccountSelector { get; set; } = true;

    /// <summary>
    /// Gets or sets the callback when the form is submitted.
    /// </summary>
    [Parameter]
    public EventCallback<TransactionCreateDto> OnSubmit { get; set; }

    /// <summary>
    /// Gets or sets the callback when cancel is clicked.
    /// </summary>
    [Parameter]
    public EventCallback OnCancel { get; set; }

    /// <summary>
    /// Gets or sets the submit button text.
    /// </summary>
    [Parameter]
    public string SubmitButtonText { get; set; } = "Save";

    /// <summary>
    /// Gets or sets a value indicating whether the form is submitting.
    /// </summary>
    [Parameter]
    public bool IsSubmitting { get; set; }

    /// <summary>
    /// Gets or sets the error message to display.
    /// </summary>
    [Parameter]
    public string? ErrorMessage { get; set; }

    /// <summary>
    /// Gets or sets the initial date to use when creating a new transaction.
    /// This will be applied to the model when the component initializes.
    /// </summary>
    [Parameter]
    public DateOnly? InitialDate { get; set; }

    /// <summary>
    /// Gets or sets the fixed account ID (used when ShowAccountSelector is false).
    /// </summary>
    [Parameter]
    public Guid? FixedAccountId { get; set; }

    /// <summary>
    /// Gets or sets the initial description.
    /// </summary>
    [Parameter]
    public string? InitialDescription { get; set; }

    /// <summary>
    /// Gets or sets the initial amount.
    /// </summary>
    [Parameter]
    public decimal InitialAmount { get; set; }

    /// <summary>
    /// Gets or sets the initial category ID.
    /// </summary>
    [Parameter]
    public Guid? InitialCategoryId { get; set; }

    private DateTime DateValue
    {
        get => Model.Date.ToDateTime(TimeOnly.MinValue);
        set => Model.Date = DateOnly.FromDateTime(value);
    }

    private decimal AmountValue
    {
        get => Model.Amount.Amount;
        set => Model.Amount = new MoneyDto { Amount = value, Currency = Model.Amount.Currency ?? "USD" };
    }

    private DateOnly? _lastAppliedInitialDate;
    private bool _initialValuesApplied;

    /// <inheritdoc/>
    protected override void OnParametersSet()
    {
        // Apply initial values if provided and not yet applied
        if (!_initialValuesApplied)
        {
            if (FixedAccountId.HasValue)
            {
                Model.AccountId = FixedAccountId.Value;
            }

            if (!string.IsNullOrEmpty(InitialDescription))
            {
                Model.Description = InitialDescription;
            }

            if (InitialAmount != 0)
            {
                Model.Amount = new MoneyDto { Amount = InitialAmount, Currency = "USD" };
            }

            if (InitialCategoryId.HasValue)
            {
                Model.CategoryId = InitialCategoryId;
            }

            _initialValuesApplied = true;
        }

        // Apply initial date if provided and different from last applied
        if (InitialDate.HasValue && InitialDate != _lastAppliedInitialDate)
        {
            Model.Date = InitialDate.Value;
            _lastAppliedInitialDate = InitialDate;
        }
    }

    private async Task HandleSubmit()
    {
        if (string.IsNullOrWhiteSpace(Model.Description))
        {
            return;
        }

        if (ShowAccountSelector && Model.AccountId == Guid.Empty)
        {
            return;
        }

        await OnSubmit.InvokeAsync(Model);
    }

    private async Task HandleCancel()
    {
        await OnCancel.InvokeAsync();
    }
}
