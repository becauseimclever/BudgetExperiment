@* TransactionForm.razor - Reusable transaction create/edit form *@

<form @onsubmit="HandleSubmit">
    @if (ShowAccountSelector)
    {
        <div class="form-group">
            <label for="txnAccount">Account:</label>
            <select id="txnAccount" @bind="Model.AccountId" required>
                <option value="">Select Account</option>
                @foreach (var account in Accounts)
                {
                    <option value="@account.Id">@account.Name</option>
                }
            </select>
        </div>
    }
    <div class="form-group">
        <label for="txnDescription">Description:</label>
        <input id="txnDescription" 
               type="text" 
               @bind="Model.Description" 
               @bind:event="oninput"
               placeholder="Enter description"
               required />
    </div>
    <div class="form-group">
        <label for="txnAmount">Amount:</label>
        <input id="txnAmount" 
               type="number" 
               step="0.01" 
               @bind="AmountValue" 
               placeholder="0.00"
               required />
        <small class="help-text">Positive for income, negative for expenses</small>
    </div>
    <div class="form-group">
        <label for="txnCategory">Category (optional):</label>
        <input id="txnCategory" 
               type="text" 
               @bind="Model.Category" 
               @bind:event="oninput"
               placeholder="e.g., Groceries, Utilities" />
    </div>
    <div class="form-group">
        <label for="txnDate">Date:</label>
        <input id="txnDate" 
               type="date" 
               @bind="DateValue" 
               required />
    </div>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="form-error">
            <span class="error-icon"><Icon Name="alert-triangle" Size="16" Class="icon-warning" /></span>
            <span class="error-text">@ErrorMessage</span>
        </div>
    }

    <div class="form-actions">
        <button type="submit" class="btn-primary" disabled="@IsSubmitting">
            @if (IsSubmitting)
            {
                <span>Saving...</span>
            }
            else
            {
                <span>@SubmitButtonText</span>
            }
        </button>
        <button type="button" class="btn-secondary" @onclick="HandleCancel" disabled="@IsSubmitting">
            Cancel
        </button>
    </div>
</form>

@code {
    /// <summary>
    /// Gets or sets the transaction model to edit.
    /// </summary>
    [Parameter]
    public TransactionCreateDto Model { get; set; } = new();

    /// <summary>
    /// Gets or sets the list of accounts for the dropdown.
    /// </summary>
    [Parameter]
    public IReadOnlyList<AccountDto> Accounts { get; set; } = Array.Empty<AccountDto>();

    /// <summary>
    /// Gets or sets a value indicating whether to show the account selector.
    /// </summary>
    [Parameter]
    public bool ShowAccountSelector { get; set; } = true;

    /// <summary>
    /// Gets or sets the callback when the form is submitted.
    /// </summary>
    [Parameter]
    public EventCallback<TransactionCreateDto> OnSubmit { get; set; }

    /// <summary>
    /// Gets or sets the callback when cancel is clicked.
    /// </summary>
    [Parameter]
    public EventCallback OnCancel { get; set; }

    /// <summary>
    /// Gets or sets the submit button text.
    /// </summary>
    [Parameter]
    public string SubmitButtonText { get; set; } = "Save";

    /// <summary>
    /// Gets or sets a value indicating whether the form is submitting.
    /// </summary>
    [Parameter]
    public bool IsSubmitting { get; set; }

    /// <summary>
    /// Gets or sets the error message to display.
    /// </summary>
    [Parameter]
    public string? ErrorMessage { get; set; }

    /// <summary>
    /// Gets or sets the initial date to use when creating a new transaction.
    /// This will be applied to the model when the component initializes.
    /// </summary>
    [Parameter]
    public DateOnly? InitialDate { get; set; }

    /// <summary>
    /// Gets or sets the fixed account ID (used when ShowAccountSelector is false).
    /// </summary>
    [Parameter]
    public Guid? FixedAccountId { get; set; }

    /// <summary>
    /// Gets or sets the initial description.
    /// </summary>
    [Parameter]
    public string? InitialDescription { get; set; }

    /// <summary>
    /// Gets or sets the initial amount.
    /// </summary>
    [Parameter]
    public decimal InitialAmount { get; set; }

    /// <summary>
    /// Gets or sets the initial category.
    /// </summary>
    [Parameter]
    public string? InitialCategory { get; set; }

    private DateTime DateValue
    {
        get => Model.Date.ToDateTime(TimeOnly.MinValue);
        set => Model.Date = DateOnly.FromDateTime(value);
    }

    private decimal AmountValue
    {
        get => Model.Amount.Amount;
        set => Model.Amount = new MoneyDto { Amount = value, Currency = Model.Amount.Currency ?? "USD" };
    }

    private DateOnly? _lastAppliedInitialDate;
    private bool _initialValuesApplied;

    /// <inheritdoc/>
    protected override void OnParametersSet()
    {
        // Apply initial values if provided and not yet applied
        if (!_initialValuesApplied)
        {
            if (FixedAccountId.HasValue)
            {
                Model.AccountId = FixedAccountId.Value;
            }

            if (!string.IsNullOrEmpty(InitialDescription))
            {
                Model.Description = InitialDescription;
            }

            if (InitialAmount != 0)
            {
                Model.Amount = new MoneyDto { Amount = InitialAmount, Currency = "USD" };
            }

            if (!string.IsNullOrEmpty(InitialCategory))
            {
                Model.Category = InitialCategory;
            }

            _initialValuesApplied = true;
        }

        // Apply initial date if provided and different from last applied
        if (InitialDate.HasValue && InitialDate != _lastAppliedInitialDate)
        {
            Model.Date = InitialDate.Value;
            _lastAppliedInitialDate = InitialDate;
        }
    }

    private async Task HandleSubmit()
    {
        if (string.IsNullOrWhiteSpace(Model.Description))
        {
            return;
        }

        if (ShowAccountSelector && Model.AccountId == Guid.Empty)
        {
            return;
        }

        await OnSubmit.InvokeAsync(Model);
    }

    private async Task HandleCancel()
    {
        await OnCancel.InvokeAsync();
    }
}
