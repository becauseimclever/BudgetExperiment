@* RecurringTransferForm.razor - Form for creating a new recurring transfer *@

@inject IBudgetApiService ApiService

<form @onsubmit="HandleSubmit">
    <FormField Label="From Account:" InputId="fromAccount">
        <select id="fromAccount" class="form-control" @bind="Model.SourceAccountId" required>
            <option value="">Select source account...</option>
            @foreach (var account in accounts.Where(a => a.Id != Model.DestinationAccountId || Model.DestinationAccountId == Guid.Empty))
            {
                <option value="@account.Id">@account.Name</option>
            }
        </select>
    </FormField>

    <FormField Label="To Account:" InputId="toAccount">
        <select id="toAccount" class="form-control" @bind="Model.DestinationAccountId" required>
            <option value="">Select destination account...</option>
            @foreach (var account in accounts.Where(a => a.Id != Model.SourceAccountId || Model.SourceAccountId == Guid.Empty))
            {
                <option value="@account.Id">@account.Name</option>
            }
        </select>
    </FormField>

    <FormField Label="Description:" InputId="description">
        <input id="description"
               type="text"
               class="form-control"
               @bind="Model.Description"
               @bind:event="oninput"
               placeholder="Enter description (e.g., Monthly Savings)"
               required />
    </FormField>

    <div class="form-row">
        <div class="form-group">
            <label for="amount">Amount:</label>
            <input id="amount"
                   type="number"
                   step="0.01"
                   min="0.01"
                   @bind="AmountValue"
                   placeholder="0.00"
                   required />
        </div>
        <div class="form-group form-group-small">
            <label for="currency">Currency:</label>
            <select id="currency" @bind="CurrencyValue">
                <option value="USD">USD</option>
            </select>
        </div>
    </div>

    <FormField Label="Frequency:" InputId="frequency">
        <select id="frequency" class="form-control" @bind="Model.Frequency" @bind:after="OnFrequencyChanged">
            <option value="Daily">Daily</option>
            <option value="Weekly">Weekly</option>
            <option value="BiWeekly">Bi-Weekly</option>
            <option value="Monthly">Monthly</option>
            <option value="Quarterly">Quarterly</option>
            <option value="Yearly">Yearly</option>
        </select>
    </FormField>

    @if (Model.Frequency == "Weekly" || Model.Frequency == "BiWeekly")
    {
        <FormField Label="Day of Week:" InputId="dayOfWeek">
            <select id="dayOfWeek" class="form-control" @bind="Model.DayOfWeek">
                <option value="Monday">Monday</option>
                <option value="Tuesday">Tuesday</option>
                <option value="Wednesday">Wednesday</option>
                <option value="Thursday">Thursday</option>
                <option value="Friday">Friday</option>
                <option value="Saturday">Saturday</option>
                <option value="Sunday">Sunday</option>
            </select>
        </FormField>
    }

    @if (Model.Frequency == "Monthly" || Model.Frequency == "Quarterly" || Model.Frequency == "Yearly")
    {
        <FormField Label="Day of Month:" InputId="dayOfMonth" HelpText="Leave empty to use start date day">
            <input id="dayOfMonth"
                   type="number"
                   class="form-control"
                   min="1"
                   max="31"
                   @bind="Model.DayOfMonth"
                   placeholder="1-31" />
        </FormField>
    }

    <div class="form-row">
        <div class="form-group">
            <label for="startDate">Start Date:</label>
            <input id="startDate"
                   type="date"
                   @bind="startDateInput"
                   required />
        </div>
        <div class="form-group">
            <label for="endDate">End Date (optional):</label>
            <input id="endDate"
                   type="date"
                   @bind="endDateInput" />
        </div>
    </div>

    <div class="form-actions">
        <Button Variant="ButtonVariant.Primary" IsLoading="@IsSubmitting" IsDisabled="@IsSubmitting" type="submit">
            @SubmitButtonText
        </Button>
        <Button Variant="ButtonVariant.Secondary" OnClick="HandleCancel" IsDisabled="@IsSubmitting" type="button">
            Cancel
        </Button>
    </div>
</form>

@code {
    /// <summary>
    /// Gets or sets the recurring transfer model to create.
    /// </summary>
    [Parameter]
    public RecurringTransferCreateDto Model { get; set; } = new();

    /// <summary>
    /// Gets or sets the callback when the form is submitted.
    /// </summary>
    [Parameter]
    public EventCallback<RecurringTransferCreateDto> OnSubmit { get; set; }

    /// <summary>
    /// Gets or sets the callback when cancel is clicked.
    /// </summary>
    [Parameter]
    public EventCallback OnCancel { get; set; }

    /// <summary>
    /// Gets or sets the submit button text.
    /// </summary>
    [Parameter]
    public string SubmitButtonText { get; set; } = "Save";

    /// <summary>
    /// Gets or sets a value indicating whether the form is submitting.
    /// </summary>
    [Parameter]
    public bool IsSubmitting { get; set; }

    private List<AccountDto> accounts = new();
    private DateTime startDateInput;
    private DateTime? endDateInput;

    private decimal AmountValue
    {
        get => Model.Amount.Amount;
        set => Model.Amount = new MoneyDto { Amount = value, Currency = Model.Amount.Currency ?? "USD" };
    }

    private string CurrencyValue
    {
        get => Model.Amount.Currency ?? "USD";
        set => Model.Amount = new MoneyDto { Amount = Model.Amount.Amount, Currency = value };
    }

    /// <inheritdoc/>
    protected override async Task OnInitializedAsync()
    {
        accounts = (await ApiService.GetAccountsAsync()).ToList();
        startDateInput = Model.StartDate.ToDateTime(TimeOnly.MinValue);
        if (Model.EndDate.HasValue)
        {
            endDateInput = Model.EndDate.Value.ToDateTime(TimeOnly.MinValue);
        }
    }

    private void OnFrequencyChanged()
    {
        // Set sensible defaults when frequency changes
        if (Model.Frequency == "Weekly" || Model.Frequency == "BiWeekly")
        {
            Model.DayOfWeek ??= "Monday";
            Model.DayOfMonth = null;
        }
        else if (Model.Frequency == "Monthly" || Model.Frequency == "Quarterly" || Model.Frequency == "Yearly")
        {
            Model.DayOfWeek = null;
        }
        else
        {
            Model.DayOfWeek = null;
            Model.DayOfMonth = null;
        }
    }

    private async Task HandleSubmit()
    {
        if (string.IsNullOrWhiteSpace(Model.Description) ||
            Model.SourceAccountId == Guid.Empty ||
            Model.DestinationAccountId == Guid.Empty)
        {
            return;
        }

        // Convert DateTime inputs to DateOnly
        Model.StartDate = DateOnly.FromDateTime(startDateInput);
        Model.EndDate = endDateInput.HasValue ? DateOnly.FromDateTime(endDateInput.Value) : null;

        await OnSubmit.InvokeAsync(Model);
    }

    private async Task HandleCancel()
    {
        await OnCancel.InvokeAsync();
    }
}
