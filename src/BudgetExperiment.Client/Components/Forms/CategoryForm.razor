@* CategoryForm.razor - Reusable budget category create/edit form *@

<form @onsubmit="HandleSubmit">
    <FormField Label="Category Name:" InputId="categoryName">
        <input id="categoryName" 
               type="text"
               class="form-control"
               @bind="Model.Name" 
               @bind:event="oninput"
               placeholder="Enter category name"
               required />
    </FormField>
    
    <FormField Label="Category Type:" InputId="categoryType" HelpText="@GetCategoryTypeHelpText()">
        <select id="categoryType" class="form-control" @bind="Model.Type" required>
            <option value="Expense">Expense</option>
            <option value="Income">Income</option>
            <option value="Transfer">Transfer</option>
        </select>
    </FormField>
    
    <div class="form-row">
        <div class="form-group form-group-half">
            <label for="categoryIcon" class="form-label">Icon:</label>
            <select id="categoryIcon" class="form-control" @bind="Model.Icon">
                <option value="">None</option>
                <option value="cart">ğŸ›’ Cart (Groceries)</option>
                <option value="home">ğŸ  Home (Housing)</option>
                <option value="car">ğŸš— Car (Transportation)</option>
                <option value="bolt">ğŸ’¡ Bolt (Utilities)</option>
                <option value="film">ğŸ¬ Film (Entertainment)</option>
                <option value="utensils">ğŸ½ï¸ Utensils (Dining)</option>
                <option value="heart">â¤ï¸ Heart (Healthcare)</option>
                <option value="shopping-bag">ğŸ›ï¸ Bag (Shopping)</option>
                <option value="briefcase">ğŸ’¼ Briefcase (Work)</option>
                <option value="trending-up">ğŸ“ˆ Trending (Investments)</option>
                <option value="gift">ğŸ Gift (Gifts)</option>
                <option value="book">ğŸ“š Book (Education)</option>
                <option value="plane">âœˆï¸ Plane (Travel)</option>
                <option value="repeat">ğŸ”„ Repeat (Subscriptions)</option>
                <option value="plus-circle">â• Plus (Other)</option>
            </select>
        </div>
        
        <div class="form-group form-group-half">
            <label for="categoryColor" class="form-label">Color:</label>
            <div class="color-picker-wrapper">
                <input id="categoryColor" 
                       type="color" 
                       class="form-control form-control-color"
                       @bind="Model.Color" />
                <input type="text" 
                       class="form-control form-control-color-text"
                       @bind="Model.Color" 
                       placeholder="#000000"
                       maxlength="7" />
            </div>
        </div>
    </div>

    @if (ShowSortOrder)
    {
        <div class="form-group">
            <label for="sortOrder" class="form-label">Sort Order:</label>
            <input id="sortOrder" 
                   type="number" 
                   class="form-control"
                   @bind="SortOrder"
                   min="0" />
            <small class="text-secondary">Lower numbers appear first in lists</small>
        </div>
    }

    @if (Model.Type == "Expense" && !ShowSortOrder)
    {
        <div class="form-group">
            <label for="initialBudget" class="form-label">Monthly Budget (optional):</label>
            <div class="input-group">
                <span class="input-group-text">$</span>
                <input id="initialBudget" 
                       type="number" 
                       class="form-control"
                       step="0.01"
                       min="0"
                       @bind="InitialBudgetAmount"
                       placeholder="0.00" />
            </div>
            <small class="text-secondary">Set an initial budget goal for the current month</small>
        </div>
    }
    
    <div class="form-actions form-actions-right">
        <Button Variant="ButtonVariant.Secondary" OnClick="HandleCancel" IsDisabled="@IsSubmitting" type="button">
            Cancel
        </Button>
        <Button Variant="ButtonVariant.Primary" IsLoading="@IsSubmitting" IsDisabled="@IsSubmitting" type="submit">
            @SubmitButtonText
        </Button>
    </div>
</form>

@code {
    /// <summary>
    /// Gets or sets the category model to edit.
    /// </summary>
    [Parameter]
    public BudgetCategoryCreateDto Model { get; set; } = new();

    /// <summary>
    /// Gets or sets the callback when the form is submitted.
    /// </summary>
    [Parameter]
    public EventCallback<BudgetCategoryCreateDto> OnSubmit { get; set; }

    /// <summary>
    /// Gets or sets the callback when cancel is clicked.
    /// </summary>
    [Parameter]
    public EventCallback OnCancel { get; set; }

    /// <summary>
    /// Gets or sets the submit button text.
    /// </summary>
    [Parameter]
    public string SubmitButtonText { get; set; } = "Create Category";

    /// <summary>
    /// Gets or sets whether the form is in a submitting state.
    /// </summary>
    [Parameter]
    public bool IsSubmitting { get; set; }

    /// <summary>
    /// Gets or sets whether to show the sort order field (for edit mode).
    /// </summary>
    [Parameter]
    public bool ShowSortOrder { get; set; } = false;

    /// <summary>
    /// Gets or sets the sort order (for edit mode).
    /// </summary>
    [Parameter]
    public int SortOrder { get; set; }

    /// <summary>
    /// Gets or sets the callback when sort order changes.
    /// </summary>
    [Parameter]
    public EventCallback<int> SortOrderChanged { get; set; }

    private decimal _initialBudgetAmount;

    /// <summary>
    /// Gets or sets the initial budget amount.
    /// </summary>
    private decimal InitialBudgetAmount
    {
        get => _initialBudgetAmount;
        set
        {
            _initialBudgetAmount = value;
            if (value > 0)
            {
                Model.InitialBudget = new MoneyDto { Amount = value, Currency = "USD" };
            }
            else
            {
                Model.InitialBudget = null;
            }
        }
    }

    private async Task HandleSubmit()
    {
        await OnSubmit.InvokeAsync(Model);
    }

    private async Task HandleCancel()
    {
        await OnCancel.InvokeAsync();
    }

    private string GetCategoryTypeHelpText()
    {
        return Model.Type switch
        {
            "Expense" => "Expense categories track spending (money going out)",
            "Income" => "Income categories track money coming in",
            "Transfer" => "Transfer categories are for internal account transfers",
            _ => string.Empty,
        };
    }
}
