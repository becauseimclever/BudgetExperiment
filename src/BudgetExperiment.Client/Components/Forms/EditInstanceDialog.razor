@* EditInstanceDialog.razor - Dialog for editing a single recurring transaction instance *@

<div>
    <div class="form-info-box">
        <p class="form-info-box-label">Editing occurrence for:</p>
        <p class="form-info-box-title">@ScheduledDate.ToString("dddd, MMMM d, yyyy")</p>
        <p class="form-info-box-subtitle">@OriginalDescription @(!string.IsNullOrEmpty(AccountName) ? $"({AccountName})" : "")</p>
    </div>

    <form @onsubmit="HandleSubmit">
        <FormField Label="Description:" InputId="description" HelpText="Leave empty to use series default">
            <input id="description"
                   type="text"
                   class="form-control"
                   @bind="descriptionInput"
                   placeholder="@OriginalDescription" />
        </FormField>

        <div class="form-row">
            <div class="form-group">
                <label for="amount" class="form-label">Amount:</label>
                <input id="amount"
                       type="number"
                       class="form-control"
                       step="0.01"
                       @bind="amountInput"
                       placeholder="@OriginalAmount.ToString("F2")" />
            </div>
            <div class="form-group form-group-sm">
                <label for="currency" class="form-label">Currency:</label>
                <select id="currency" class="form-control" @bind="currencyInput">
                    <option value="USD">USD</option>
                </select>
            </div>
        </div>

        <FormField Label="Reschedule to:" InputId="newDate" HelpText="Leave empty to keep original date">
            <input id="newDate"
                   type="date"
                   class="form-control"
                   @bind="newDateInput" />
        </FormField>

        <div class="form-actions form-actions-right">
            <Button Variant="ButtonVariant.Secondary" OnClick="HandleCancel" IsDisabled="@IsSubmitting" type="button">
                Cancel
            </Button>
            <Button Variant="ButtonVariant.Primary" IsLoading="@IsSubmitting" IsDisabled="@IsSubmitting" type="submit">
                Save This Occurrence
            </Button>
        </div>
    </form>
</div>

@code {
    /// <summary>
    /// Gets or sets the scheduled date of the instance being edited.
    /// </summary>
    [Parameter, EditorRequired]
    public DateOnly ScheduledDate { get; set; }

    /// <summary>
    /// Gets or sets the original description from the series.
    /// </summary>
    [Parameter, EditorRequired]
    public string OriginalDescription { get; set; } = string.Empty;

    /// <summary>
    /// Gets or sets the original amount from the series.
    /// </summary>
    [Parameter, EditorRequired]
    public decimal OriginalAmount { get; set; }

    /// <summary>
    /// Gets or sets the original currency from the series.
    /// </summary>
    [Parameter]
    public string OriginalCurrency { get; set; } = "USD";

    /// <summary>
    /// Gets or sets the account name for display (optional).
    /// </summary>
    [Parameter]
    public string? AccountName { get; set; }

    /// <summary>
    /// Gets or sets the callback when the form is saved.
    /// </summary>
    [Parameter]
    public EventCallback<RecurringInstanceModifyDto> OnSave { get; set; }

    /// <summary>
    /// Gets or sets the callback when cancel is clicked.
    /// </summary>
    [Parameter]
    public EventCallback OnCancel { get; set; }

    /// <summary>
    /// Gets or sets a value indicating whether the form is submitting.
    /// </summary>
    [Parameter]
    public bool IsSubmitting { get; set; }

    private RecurringInstanceModifyDto model = new();
    private DateTime? newDateInput;
    private decimal? amountInput;
    private string currencyInput = "USD";
    private string? descriptionInput;

    protected override void OnParametersSet()
    {
        currencyInput = OriginalCurrency;
    }

    private async Task HandleSubmit()
    {
        model.Date = newDateInput.HasValue ? DateOnly.FromDateTime(newDateInput.Value) : null;
        model.Description = string.IsNullOrWhiteSpace(descriptionInput) ? null : descriptionInput;
        model.Amount = amountInput.HasValue
            ? new MoneyDto { Amount = amountInput.Value, Currency = currencyInput }
            : null;
        await OnSave.InvokeAsync(model);
    }

    private async Task HandleCancel()
    {
        await OnCancel.InvokeAsync();
    }
}
