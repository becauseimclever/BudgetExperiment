@* EditInstanceDialog.razor - Dialog for editing a single recurring transaction instance *@

<div class="edit-instance-form">
    <div class="instance-info">
        <p class="instance-label">Editing occurrence for:</p>
        <p class="instance-date">@ScheduledDate.ToString("dddd, MMMM d, yyyy")</p>
        <p class="instance-series">@OriginalDescription @(!string.IsNullOrEmpty(AccountName) ? $"({AccountName})" : "")</p>
    </div>

    <form @onsubmit="HandleSubmit">
        <div class="form-group">
            <label for="description">Description:</label>
            <input id="description"
                   type="text"
                   @bind="descriptionInput"
                   placeholder="@OriginalDescription" />
            <small class="form-hint">Leave empty to use series default</small>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="amount">Amount:</label>
                <input id="amount"
                       type="number"
                       step="0.01"
                       @bind="amountInput"
                       placeholder="@OriginalAmount.ToString("F2")" />
            </div>
            <div class="form-group form-group-small">
                <label for="currency">Currency:</label>
                <select id="currency" @bind="currencyInput">
                    <option value="USD">USD</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label for="newDate">Reschedule to:</label>
            <input id="newDate"
                   type="date"
                   @bind="newDateInput" />
            <small class="form-hint">Leave empty to keep original date</small>
        </div>

        <div class="form-actions">
            <button type="submit" class="btn-primary" disabled="@IsSubmitting">
                @if (IsSubmitting)
                {
                    <span>Saving...</span>
                }
                else
                {
                    <span>Save This Occurrence</span>
                }
            </button>
            <button type="button" class="btn-secondary" @onclick="HandleCancel" disabled="@IsSubmitting">
                Cancel
            </button>
        </div>
    </form>
</div>

@code {
    /// <summary>
    /// Gets or sets the scheduled date of the instance being edited.
    /// </summary>
    [Parameter, EditorRequired]
    public DateOnly ScheduledDate { get; set; }

    /// <summary>
    /// Gets or sets the original description from the series.
    /// </summary>
    [Parameter, EditorRequired]
    public string OriginalDescription { get; set; } = string.Empty;

    /// <summary>
    /// Gets or sets the original amount from the series.
    /// </summary>
    [Parameter, EditorRequired]
    public decimal OriginalAmount { get; set; }

    /// <summary>
    /// Gets or sets the original currency from the series.
    /// </summary>
    [Parameter]
    public string OriginalCurrency { get; set; } = "USD";

    /// <summary>
    /// Gets or sets the account name for display (optional).
    /// </summary>
    [Parameter]
    public string? AccountName { get; set; }

    /// <summary>
    /// Gets or sets the callback when the form is saved.
    /// </summary>
    [Parameter]
    public EventCallback<RecurringInstanceModifyDto> OnSave { get; set; }

    /// <summary>
    /// Gets or sets the callback when cancel is clicked.
    /// </summary>
    [Parameter]
    public EventCallback OnCancel { get; set; }

    /// <summary>
    /// Gets or sets a value indicating whether the form is submitting.
    /// </summary>
    [Parameter]
    public bool IsSubmitting { get; set; }

    private RecurringInstanceModifyDto model = new();
    private DateTime? newDateInput;
    private decimal? amountInput;
    private string currencyInput = "USD";
    private string? descriptionInput;

    protected override void OnParametersSet()
    {
        currencyInput = OriginalCurrency;
    }

    private async Task HandleSubmit()
    {
        model.Date = newDateInput.HasValue ? DateOnly.FromDateTime(newDateInput.Value) : null;
        model.Description = string.IsNullOrWhiteSpace(descriptionInput) ? null : descriptionInput;
        model.Amount = amountInput.HasValue
            ? new MoneyDto { Amount = amountInput.Value, Currency = currencyInput }
            : null;
        await OnSave.InvokeAsync(model);
    }

    private async Task HandleCancel()
    {
        await OnCancel.InvokeAsync();
    }
}
