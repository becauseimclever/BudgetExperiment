@* AiSettingsForm.razor - Form for configuring AI settings *@

@inject IAiApiService AiService

<div class="ai-settings-form">
    @if (isLoading)
    {
        <LoadingSpinner Message="Loading AI settings..." />
    }
    else if (settings != null)
    {
        <form @onsubmit="HandleSubmit">
            <div class="form-group">
                <label for="ollamaEndpoint" class="form-label">Ollama Endpoint:</label>
                <input id="ollamaEndpoint"
                       type="url"
                       class="form-control"
                       @bind="settings.OllamaEndpoint"
                       placeholder="http://localhost:11434"
                       required />
                <small class="text-secondary">The URL of your Ollama instance</small>
            </div>

            <div class="form-row">
                <div class="form-group form-group-half">
                    <label for="modelName" class="form-label">Model:</label>
                    @if (availableModels.Count > 0)
                    {
                        <select id="modelName" class="form-control" @bind="settings.ModelName">
                            @foreach (var model in availableModels)
                            {
                                <option value="@model.Name">@model.Name (@FormatSize(model.SizeBytes))</option>
                            }
                        </select>
                    }
                    else
                    {
                        <input id="modelName"
                               type="text"
                               class="form-control"
                               @bind="settings.ModelName"
                               placeholder="llama3.2" />
                    }
                    <small class="text-secondary">The AI model to use for analysis</small>
                </div>

                <div class="form-group form-group-half">
                    <label for="temperature" class="form-label">Temperature:</label>
                    <input id="temperature"
                           type="number"
                           class="form-control"
                           @bind="settings.Temperature"
                           min="0"
                           max="1"
                           step="0.1" />
                    <small class="text-secondary">Lower = more consistent, Higher = more creative</small>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group form-group-half">
                    <label for="maxTokens" class="form-label">Max Tokens:</label>
                    <input id="maxTokens"
                           type="number"
                           class="form-control"
                           @bind="settings.MaxTokens"
                           min="100"
                           max="8000" />
                    <small class="text-secondary">Maximum response length</small>
                </div>

                <div class="form-group form-group-half">
                    <label for="timeout" class="form-label">Timeout (seconds):</label>
                    <input id="timeout"
                           type="number"
                           class="form-control"
                           @bind="settings.TimeoutSeconds"
                           min="30"
                           max="600" />
                    <small class="text-secondary">Request timeout</small>
                </div>
            </div>

            <div class="form-group">
                <div class="form-check">
                    <input type="checkbox"
                           id="isEnabled"
                           class="form-check-input"
                           @bind="settings.IsEnabled" />
                    <label for="isEnabled" class="form-check-label">Enable AI Features</label>
                </div>
                <small class="text-secondary">When disabled, all AI features are turned off</small>
            </div>

            <div class="form-actions">
                <button type="button"
                        class="btn btn-secondary"
                        @onclick="TestConnection"
                        disabled="@isTesting">
                    @if (isTesting)
                    {
                        <span>Testing...</span>
                    }
                    else
                    {
                        <span>üîå Test Connection</span>
                    }
                </button>

                <button type="button"
                        class="btn btn-secondary"
                        @onclick="RefreshModels"
                        disabled="@isRefreshingModels">
                    @if (isRefreshingModels)
                    {
                        <span>Loading...</span>
                    }
                    else
                    {
                        <span>üîÑ Refresh Models</span>
                    }
                </button>

                <button type="submit" class="btn btn-primary" disabled="@isSaving">
                    @if (isSaving)
                    {
                        <span>Saving...</span>
                    }
                    else
                    {
                        <span>üíæ Save Settings</span>
                    }
                </button>
            </div>
        </form>

        @if (connectionStatus != null)
        {
            <div class="connection-status mt-3 @(connectionStatus.IsAvailable ? "status-success" : "status-error")">
                @if (connectionStatus.IsAvailable)
                {
                    <span class="status-icon">‚úÖ</span>
                    <span>Connected to Ollama - Model: @connectionStatus.CurrentModel</span>
                }
                else
                {
                    <span class="status-icon">‚ùå</span>
                    <span>Connection failed: @connectionStatus.ErrorMessage</span>
                }
            </div>
        }
    }
    else
    {
        <div class="alert alert-warning">
            Unable to load AI settings. Please try again.
        </div>
    }
</div>

@code {
    /// <summary>
    /// Event callback when settings are saved.
    /// </summary>
    [Parameter]
    public EventCallback<AiSettingsDto> OnSave { get; set; }

    /// <summary>
    /// Event callback when an error occurs.
    /// </summary>
    [Parameter]
    public EventCallback<string> OnError { get; set; }

    private AiSettingsDto? settings;
    private AiStatusDto? connectionStatus;
    private IReadOnlyList<AiModelDto> availableModels = Array.Empty<AiModelDto>();
    private bool isLoading = true;
    private bool isSaving = false;
    private bool isTesting = false;
    private bool isRefreshingModels = false;

    /// <inheritdoc />
    protected override async Task OnInitializedAsync()
    {
        await LoadSettingsAsync();
    }

    private async Task LoadSettingsAsync()
    {
        isLoading = true;
        settings = await AiService.GetSettingsAsync();
        availableModels = await AiService.GetModelsAsync();
        isLoading = false;
    }

    private async Task TestConnection()
    {
        isTesting = true;
        connectionStatus = await AiService.GetStatusAsync();
        isTesting = false;
    }

    private async Task RefreshModels()
    {
        isRefreshingModels = true;
        availableModels = await AiService.GetModelsAsync();
        isRefreshingModels = false;
    }

    private async Task HandleSubmit()
    {
        if (settings == null) return;

        isSaving = true;
        try
        {
            var updated = await AiService.UpdateSettingsAsync(settings);
            if (updated != null)
            {
                settings = updated;
                await OnSave.InvokeAsync(updated);
            }
            else
            {
                await OnError.InvokeAsync("Failed to save settings");
            }
        }
        catch (Exception ex)
        {
            await OnError.InvokeAsync($"Error saving settings: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }

    private static string FormatSize(long bytes)
    {
        if (bytes >= 1_073_741_824)
            return $"{bytes / 1_073_741_824.0:F1} GB";
        if (bytes >= 1_048_576)
            return $"{bytes / 1_048_576.0:F1} MB";
        return $"{bytes / 1024.0:F1} KB";
    }
}
