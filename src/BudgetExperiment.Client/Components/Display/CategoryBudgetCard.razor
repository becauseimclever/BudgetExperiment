@* CategoryBudgetCard.razor - Display card for category budget progress *@

<div class="card category-budget-card @GetStatusClass()">
    <div class="card-body">
        <div class="category-budget-header">
            <span class="category-icon" style="@GetIconStyle()">
                @GetIconEmoji()
            </span>
            <div class="category-info">
                <h4 class="card-title-sm">@Progress.CategoryName</h4>
                @if (Progress.Status == "NoBudgetSet")
                {
                    <span class="budget-amounts text-secondary">No budget set</span>
                }
                else
                {
                    <span class="budget-amounts">
                        <MoneyDisplay Amount="@Progress.SpentAmount.Amount" CurrencyCode="@Progress.SpentAmount.Currency" />
                        <span class="text-secondary"> / </span>
                        <MoneyDisplay Amount="@Progress.TargetAmount.Amount" CurrencyCode="@Progress.TargetAmount.Currency" />
                    </span>
                }
            </div>
        </div>
        
        @if (Progress.Status != "NoBudgetSet")
        {
            <BudgetProgressBar PercentUsed="@Progress.PercentUsed" Status="@Progress.Status" />
        }
        
        <div class="budget-details">
            @if (Progress.Status == "NoBudgetSet")
            {
                <span class="text-secondary">Set a budget to track spending</span>
            }
            else
            {
                <span class="budget-remaining @(Progress.RemainingAmount.Amount < 0 ? "text-expense" : "text-income")">
                    @if (Progress.RemainingAmount.Amount >= 0)
                    {
                        <span>@Progress.RemainingAmount.Amount.ToString("C") remaining</span>
                    }
                    else
                    {
                        <span>@Math.Abs(Progress.RemainingAmount.Amount).ToString("C") over budget</span>
                    }
                </span>
            }
            <span class="text-secondary text-sm">@Progress.TransactionCount transactions</span>
        </div>
    </div>
    
    @if (ShowEditButton)
    {
        <div class="card-footer">
            @if (Progress.Status == "NoBudgetSet")
            {
                <button class="btn btn-sm btn-primary" @onclick="HandleEditGoal" title="Set budget goal">
                    <Icon Name="plus" Size="16" /> Set Budget
                </button>
            }
            else
            {
                <button class="btn btn-sm btn-secondary" @onclick="HandleEditGoal" title="Edit budget goal">
                    <Icon Name="edit" Size="16" /> Edit Goal
                </button>
            }
        </div>
    }
</div>

@code {
    /// <summary>
    /// Gets or sets the budget progress to display.
    /// </summary>
    [Parameter]
    public BudgetProgressDto Progress { get; set; } = new();

    /// <summary>
    /// Gets or sets whether to show the edit button.
    /// </summary>
    [Parameter]
    public bool ShowEditButton { get; set; } = true;

    /// <summary>
    /// Gets or sets the callback when edit goal is clicked.
    /// </summary>
    [Parameter]
    public EventCallback<BudgetProgressDto> OnEditGoal { get; set; }

    private async Task HandleEditGoal() => await OnEditGoal.InvokeAsync(Progress);

    private string GetStatusClass()
    {
        return Progress.Status switch
        {
            "OverBudget" => "status-danger",
            "Warning" => "status-warning",
            "OnTrack" => "status-success",
            "NoBudgetSet" => "status-no-budget",
            _ => ""
        };
    }

    private string GetIconStyle()
    {
        if (string.IsNullOrEmpty(Progress.CategoryColor))
        {
            return string.Empty;
        }

        return $"background-color: {Progress.CategoryColor}20; border-color: {Progress.CategoryColor};";
    }

    private string GetIconEmoji()
    {
        return Progress.CategoryIcon switch
        {
            "cart" => "üõí",
            "home" => "üè†",
            "car" => "üöó",
            "bolt" => "üí°",
            "film" => "üé¨",
            "utensils" => "üçΩÔ∏è",
            "heart" => "‚ù§Ô∏è",
            "shopping-bag" => "üõçÔ∏è",
            "briefcase" => "üíº",
            "trending-up" => "üìà",
            "gift" => "üéÅ",
            "book" => "üìö",
            "plane" => "‚úàÔ∏è",
            "repeat" => "üîÑ",
            "plus-circle" => "‚ûï",
            _ => "üìÅ"
        };
    }
}
