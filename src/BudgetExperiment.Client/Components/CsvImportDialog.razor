@* <copyright file="CsvImportDialog.razor" company="Fortinbra">
 Copyright (c) 2025 Fortinbra (becauseimclever.com). All rights reserved.
</copyright> *@

@using Microsoft.FluentUI.AspNetCore.Components
@using BudgetExperiment.Client.Models
@using BudgetExperiment.Client.Api
@using BudgetExperiment.Domain

@if (IsOpen)
{
<FluentDialog @bind-Open="@IsOpen" Modal="true" TrapFocus="true" @ref="dialog" Style="@DialogStyle">
    <FluentDialogHeader>
        <FluentStack Orientation="Orientation.Horizontal" VerticalAlignment="VerticalAlignment.Center">
            <FluentIcon Value="@(new Icons.Regular.Size24.ArrowUpload())" />
            <FluentLabel Typo="Typography.PaneHeader">Import Bank Transactions</FluentLabel>
        </FluentStack>
    </FluentDialogHeader>
    <FluentDialogBody Style="overflow-y: auto; max-height: calc(90vh - 150px);">
        <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">
            @if (!isBusy && importResult is null && previewRows is null)
            {
                <!-- Bank Selection -->
                <FluentSelect Label="Select Your Bank" @bind-Value="selectedBankType" Style="width: 100%;" TOption="string">
                    <FluentOption Value="BankOfAmerica" TOption="string">Bank of America</FluentOption>
                    <FluentOption Value="CapitalOne" TOption="string">Capital One</FluentOption>
                    <FluentOption Value="UnitedHeritageCreditUnion" TOption="string">United Heritage Credit Union</FluentOption>
                </FluentSelect>

                <!-- File Upload -->
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
                    <FluentLabel Weight="FontWeight.Bold">CSV File</FluentLabel>
                    <InputFile OnChange="HandleFileSelected" accept=".csv" />
                    @if (!string.IsNullOrEmpty(selectedFileName))
                    {
                        <FluentLabel Typo="Typography.Body">Selected: @selectedFileName</FluentLabel>
                    }
                </FluentStack>
            }

            <!-- Import Progress -->
            @if (isBusy)
            {
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="12" HorizontalAlignment="HorizontalAlignment.Center">
                    <FluentProgressRing />
                    <FluentLabel Typo="Typography.Body">Working...</FluentLabel>
                </FluentStack>
            }

            <!-- Import Results -->
            @if (importResult is not null)
            {
                <FluentMessageBar Intent="@GetMessageIntent()" Style="margin-top: 16px;">
                    <strong>Import Complete:</strong> @importResult.SuccessfulImports of @importResult.TotalRows transactions imported
                    @if (importResult.FailedImports > 0)
                    {
                        <span> (@importResult.FailedImports errors)</span>
                    }
                </FluentMessageBar>

                @if (importResult.DuplicatesSkipped > 0)
                {
                    <FluentMessageBar Intent="MessageIntent.Warning" Style="margin-top: 12px;">
                        <strong>Note:</strong> Skipped @importResult.DuplicatesSkipped duplicate transaction(s).
                    </FluentMessageBar>
                }

                @if (importResult.Errors != null && importResult.Errors.Any())
                {
                    <FluentAccordion Style="margin-top: 16px;">
                        <FluentAccordionItem Heading="View Errors">
                            <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
                                @foreach (var error in importResult.Errors)
                                {
                                    <FluentLabel Typo="Typography.Body">
                                        <strong>Row @error.RowNumber:</strong> @error.ErrorMessage
                                    </FluentLabel>
                                }
                            </FluentStack>
                        </FluentAccordionItem>
                    </FluentAccordion>
                }

                @if (importResult.Duplicates != null && importResult.Duplicates.Any())
                {
                    <FluentAccordion Style="margin-top: 12px;">
                        <FluentAccordionItem Heading="View Duplicates">
                            <FluentStack Orientation="Orientation.Vertical" VerticalGap="8">
                                @foreach (var dup in importResult.Duplicates)
                                {
                                    <FluentLabel Typo="Typography.Body">
                                        <strong>Row @dup.RowNumber:</strong>
                                        @dup.Date.ToString("yyyy-MM-dd") · @dup.Description · @dup.Amount.ToString("C")
                                    </FluentLabel>
                                }
                            </FluentStack>
                        </FluentAccordionItem>
                    </FluentAccordion>
                }
            }

            <!-- Preview Grid -->
            @if (previewRows is not null && importResult is null)
            {
                <FluentStack Orientation="Orientation.Vertical" VerticalGap="12">
                    <FluentLabel Typo="Typography.H6">Preview Transactions</FluentLabel>
                    <div style="overflow-x: auto; overflow-y: auto; max-height: 55vh; border: 1px solid var(--neutral-stroke-layer-rest); border-radius: 4px;">
                        <table style="width:100%; border-collapse: collapse; min-width: 1100px;">
                            <thead>
                                <tr style="position: sticky; top:0; background: var(--neutral-layer-1); z-index: 10; box-shadow: 0 1px 0 var(--neutral-stroke-layer-rest);">
                                    <th style="text-align:left; padding:8px; white-space: nowrap;">Row</th>
                                    <th style="text-align:left; padding:8px; white-space: nowrap;">Date</th>
                                    <th style="text-align:left; padding:8px; white-space: nowrap;">Description</th>
                                    <th style="text-align:right; padding:8px; white-space: nowrap;">Amount</th>
                                    <th style="text-align:left; padding:8px; white-space: nowrap;">Type</th>
                                    <th style="text-align:left; padding:8px; white-space: nowrap;">Category</th>
                                    <th style="text-align:center; padding:8px; white-space: nowrap;">Duplicate</th>
                                    <th style="text-align:center; padding:8px; white-space: nowrap;">Import Anyway</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var (row, edited, index) in previewRows.Select((r, idx) => (r, editedRows[idx], idx)))
                                {
                                    var isDup = row.IsDuplicate;
                                    var currentIndex = index;
                                    <tr style="@(isDup ? "background: var(--palette-yellow-background-2);" : string.Empty)">
                                        <td style="padding:8px;">@row.RowNumber</td>
                                        <td style="padding:8px; min-width: 140px;">
                                            <input type="date" value="@edited.DateString"
                                                   @onchange="@(e => UpdateRow(currentIndex, edited with { DateString = e.Value?.ToString() ?? edited.DateString }))"
                                                   style="width:100%; padding:6px; border: 1px solid var(--neutral-stroke-control-default); border-radius: 4px;" />
                                        </td>
                                        <td style="padding:8px; min-width: 260px;">
                                            <input type="text" value="@edited.Description" 
                                                   @oninput="@(e => UpdateRow(currentIndex, edited with { Description = e.Value?.ToString() ?? edited.Description }))"
                                                   style="width:100%; padding:6px; border: 1px solid var(--neutral-stroke-control-default); border-radius: 4px;" />
                                        </td>
                                        <td style="padding:8px; text-align:right;">@row.Amount.ToString("C")</td>
                                        <td style="padding:8px;">@row.TransactionType</td>
                                        <td style="padding:8px; min-width: 160px;">
                                            <input type="text" value="@edited.Category"
                                                   @oninput="@(e => UpdateRow(currentIndex, edited with { Category = e.Value?.ToString() }))"
                                                   style="width:100%; padding:6px; border: 1px solid var(--neutral-stroke-control-default); border-radius: 4px;" />
                                        </td>
                                        <td style="padding:8px; text-align:center;">@(isDup ? "Yes" : "No")</td>
                                        <td style="padding:8px; text-align:center;">
                                            <input type="checkbox" checked="@edited.ForceImport"
                                                   @onchange="@(e => UpdateRow(currentIndex, edited with { ForceImport = e.Value is bool b && b }))" />
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <FluentLabel Typo="Typography.Body">Note: Duplicates are highlighted. Edit date/description to deduplicate or check "Import Anyway" to force import.</FluentLabel>
                </FluentStack>
            }
        </FluentStack>
    </FluentDialogBody>
    <FluentDialogFooter>
        @if (!isBusy && importResult is null && previewRows is null)
        {
            <FluentButton Appearance="Appearance.Accent"
                          OnClick="PreviewCsv"
                          Disabled="@(!CanImport())">
                Preview
            </FluentButton>
            <FluentButton Appearance="Appearance.Neutral" OnClick="Cancel">
                Cancel
            </FluentButton>
        }
        else if (!isBusy && importResult is null && previewRows is not null)
        {
            <FluentButton Appearance="Appearance.Accent" OnClick="CommitImport">
                Import
            </FluentButton>
            <FluentButton Appearance="Appearance.Neutral" OnClick="BackToSelection">
                Back
            </FluentButton>
        }
        else if (importResult is not null)
        {
            <FluentButton Appearance="Appearance.Accent" OnClick="CloseAfterImport">
                Close
            </FluentButton>
        }
    </FluentDialogFooter>
</FluentDialog>
}

@code {
    private FluentDialog? dialog;
    private IBrowserFile? selectedFile;
    private string? selectedFileName;
    private string selectedBankType = "BankOfAmerica";
    private bool isBusy;
    private CsvImportResult? importResult;
    private List<CsvImportPreviewRowDto>? previewRows;

    private List<EditableRow> editedRows = new();

    [Parameter]
    public bool IsOpen { get; set; } = false;

    [Parameter]
    public EventCallback<bool> IsOpenChanged { get; set; }

    [Parameter]
    public EventCallback OnImportSuccess { get; set; }

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        selectedFileName = e.File.Name;
        importResult = null; // Clear previous results
        previewRows = null;
        editedRows.Clear();
    }

    private bool CanImport()
    {
        return selectedFile != null && !string.IsNullOrWhiteSpace(selectedBankType);
    }

    private async Task PreviewCsv()
    {
        if (selectedFile == null)
        {
            return;
        }

        isBusy = true;
        importResult = null;
        previewRows = null;

        try
        {
            var rows = await CsvImportApi.PreviewAsync(selectedFile, selectedBankType);
            if (rows is null)
            {
                previewRows = new();
                return;
            }

            previewRows = rows;
            editedRows = rows.Select(r => new EditableRow
            {
                RowNumber = r.RowNumber,
                DateString = new DateTime(r.Date.Year, r.Date.Month, r.Date.Day).ToString("yyyy-MM-dd"),
                Description = r.Description,
                Amount = r.Amount,
                TransactionType = r.TransactionType,
                Category = r.Category,
                ForceImport = false,
                IsDuplicate = r.IsDuplicate
            }).ToList();
        }
        catch (Exception ex)
        {
            importResult = new CsvImportResult
            {
                TotalRows = 0,
                SuccessfulImports = 0,
                FailedImports = 0,
                DuplicatesSkipped = 0,
                Errors = new List<CsvImportError> { new CsvImportError { RowNumber = 0, Field = "Client", ErrorMessage = ex.Message } }
            };
        }
        finally { isBusy = false; }
    }

    private MessageIntent GetMessageIntent()
    {
        if (importResult is null)
        {
            return MessageIntent.Info;
        }

        if (importResult.FailedImports > 0)
        {
            return MessageIntent.Warning;
        }

        return MessageIntent.Success;
    }

    private async Task Cancel()
    {
        IsOpen = false;
        await IsOpenChanged.InvokeAsync(false);
        ResetDialog();
    }

    private async Task CloseAfterImport()
    {
        IsOpen = false;
        await IsOpenChanged.InvokeAsync(false);
        ResetDialog();
    }

    private void ResetDialog()
    {
        selectedFile = null;
        selectedFileName = null;
        importResult = null;
        isBusy = false;
        selectedBankType = "BankOfAmerica";
        previewRows = null;
        editedRows.Clear();
    }

    [Inject]
    private NavigationManager NavigationManager { get; set; } = default!;

    [Inject]
    private ICsvImportApi CsvImportApi { get; set; } = default!;

    private async Task CommitImport()
    {
        if (previewRows is null)
        {
            return;
        }

        isBusy = true;
        try
        {
            var items = editedRows.Select(er => new CommitTransactionDto
            {
                RowNumber = er.RowNumber,
                Date = DateOnly.FromDateTime(DateTime.Parse(er.DateString)),
                Description = er.Description,
                Amount = er.Amount,
                TransactionType = er.TransactionType,
                Category = er.Category,
                ForceImport = er.ForceImport && er.IsDuplicate,
            }).ToList();

            var result = await CsvImportApi.CommitAsync(items);
            importResult = result ?? new CsvImportResult
            {
                TotalRows = items.Count,
                Errors = new List<CsvImportError> { new CsvImportError { Field = "API", ErrorMessage = "Commit failed." } }
            };

            if (importResult.SuccessfulImports > 0)
            {
                await OnImportSuccess.InvokeAsync();
            }
        }
        finally
        {
            isBusy = false;
        }
    }

    private void BackToSelection()
    {
        previewRows = null;
        editedRows.Clear();
    }

    private void UpdateRow(int index, EditableRow updatedRow)
    {
        if (index >= 0 && index < editedRows.Count)
        {
            editedRows[index] = updatedRow;
        }
    }

    private string DialogStyle => previewRows is not null 
        ? "--dialog-width: 90vw; --dialog-max-width: 1400px; --dialog-height: auto; --dialog-max-height: 90vh;" 
        : "--dialog-width: 500px; --dialog-max-width: 600px; --dialog-height: auto;";

    private record EditableRow
    {
        public int RowNumber { get; init; }
        public string DateString { get; init; } = string.Empty;
        public string Description { get; init; } = string.Empty;
        public decimal Amount { get; init; }
        public TransactionType TransactionType { get; init; }
        public string? Category { get; init; }
        public bool ForceImport { get; init; }
        public bool IsDuplicate { get; init; }
    }
}
