@* NavMenu.razor - Collapsible side navigation menu *@

@using BudgetExperiment.Client.Services
@using Microsoft.AspNetCore.Components.Authorization

@inject IBudgetApiService ApiService
@inject IAiAvailabilityService AiAvailability
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JSRuntime

@implements IDisposable

<nav class="nav-menu @(IsCollapsed ? "collapsed" : "expanded")" aria-label="Main menu">
    <ScopeSwitcher IsCollapsed="@IsCollapsed" />

    <ul class="nav-items" role="list">
        <li>
            <NavLink class="nav-item" href="" Match="NavLinkMatch.All" title="Calendar" aria-label="Calendar - Home">
                <span class="nav-icon" aria-hidden="true"><Icon Name="calendar" Size="20" /></span>
                @if (!IsCollapsed)
                {
                    <span class="nav-text">Calendar</span>
                }
            </NavLink>
        </li>

        <li>
            <NavLink class="nav-item" href="recurring" title="Recurring Bills" aria-label="Recurring Bills">
                <span class="nav-icon" aria-hidden="true"><Icon Name="refresh" Size="20" /></span>
                @if (!IsCollapsed)
                {
                    <span class="nav-text">Recurring Bills</span>
                }
            </NavLink>
        </li>

        <li>
            <NavLink class="nav-item" href="recurring-transfers" title="Auto-Transfers" aria-label="Automatic Transfers">
                <span class="nav-icon" aria-hidden="true"><Icon Name="repeat" Size="20" /></span>
                @if (!IsCollapsed)
                {
                    <span class="nav-text">Auto-Transfers</span>
                }
            </NavLink>
        </li>

        <li>
            <NavLink class="nav-item" href="reconciliation" title="Reconciliation" aria-label="Account Reconciliation">
                <span class="nav-icon" aria-hidden="true"><Icon Name="check-circle" Size="20" /></span>
                @if (!IsCollapsed)
                {
                    <span class="nav-text">Reconciliation</span>
                }
            </NavLink>
        </li>

        <li>
            <NavLink class="nav-item" href="transfers" title="Transfers" aria-label="Transfers between accounts">
                <span class="nav-icon" aria-hidden="true"><Icon Name="arrows-horizontal" Size="20" /></span>
                @if (!IsCollapsed)
                {
                    <span class="nav-text">Transfers</span>
                }
            </NavLink>
        </li>

        <li>
            <NavLink class="nav-item" href="paycheck-planner" title="Paycheck Planner" aria-label="Paycheck Planner">
                <span class="nav-icon" aria-hidden="true"><Icon Name="calculator" Size="20" /></span>
                @if (!IsCollapsed)
                {
                    <span class="nav-text">Paycheck Planner</span>
                }
            </NavLink>
        </li>

        <li>
            <NavLink class="nav-item" href="categories" title="Budget Categories" aria-label="Budget Categories">
                <span class="nav-icon" aria-hidden="true"><Icon Name="tag" Size="20" /></span>
                @if (!IsCollapsed)
                {
                    <span class="nav-text">Categories</span>
                }
            </NavLink>
        </li>

        <li>
            <NavLink class="nav-item" href="rules" title="Auto-Categorize" aria-label="Auto-categorization rules">
                <span class="nav-icon" aria-hidden="true"><Icon Name="filter" Size="20" /></span>
                @if (!IsCollapsed)
                {
                    <span class="nav-text">Auto-Categorize</span>
                }
            </NavLink>
        </li>

        <li>
            <NavLink class="nav-item" href="uncategorized" title="Uncategorized Transactions" aria-label="Uncategorized Transactions">
                <span class="nav-icon" aria-hidden="true"><Icon Name="inbox" Size="20" /></span>
                @if (!IsCollapsed)
                {
                    <span class="nav-text">Uncategorized</span>
                }
            </NavLink>
        </li>

        <li>
            <NavLink class="nav-item" href="budget" title="Budget Overview" aria-label="Budget Overview">
                <span class="nav-icon" aria-hidden="true"><Icon Name="pie-chart" Size="20" /></span>
                @if (!IsCollapsed)
                {
                    <span class="nav-text">Budget</span>
                }
            </NavLink>
        </li>

        <li class="nav-section">
            <button class="nav-item nav-section-toggle"
                    @onclick="ToggleReportsSection"
                    title="Reports"
                    aria-expanded="@reportsExpanded"
                    aria-controls="reports-submenu">
                <span class="nav-icon" aria-hidden="true"><Icon Name="bar-chart" Size="20" /></span>
                @if (!IsCollapsed)
                {
                    <span class="nav-text">Reports</span>
                    <span class="nav-chevron @(reportsExpanded ? "expanded" : "")" aria-hidden="true">
                        <Icon Name="chevron-down" Size="16" />
                    </span>
                }
            </button>

            @if (!IsCollapsed && reportsExpanded)
            {
                <ul id="reports-submenu" class="nav-subitems" role="list">
                    <li>
                        <NavLink class="nav-item nav-subitem" href="reports" Match="NavLinkMatch.All" title="Reports Overview" aria-label="Reports Overview">
                            <span class="nav-icon" aria-hidden="true"><Icon Name="pie-chart" Size="16" /></span>
                            <span class="nav-text">Overview</span>
                        </NavLink>
                    </li>
                    <li>
                        <NavLink class="nav-item nav-subitem" href="reports/categories" title="Category Spending" aria-label="Category Spending Report">
                            <span class="nav-icon" aria-hidden="true"><Icon Name="tag" Size="16" /></span>
                            <span class="nav-text">Categories</span>
                        </NavLink>
                    </li>
                </ul>
            }
        </li>

        <li class="nav-section">
            <button class="nav-item nav-section-toggle"
                    @onclick="ToggleAccountsSection"
                    title="Accounts"
                    aria-expanded="@accountsExpanded"
                    aria-controls="accounts-submenu">
                <span class="nav-icon" aria-hidden="true"><Icon Name="bank" Size="20" /></span>
                @if (!IsCollapsed)
                {
                    <span class="nav-text">Accounts</span>
                    <span class="nav-chevron @(accountsExpanded ? "expanded" : "")" aria-hidden="true">
                        <Icon Name="chevron-down" Size="16" />
                    </span>
                }
            </button>

            @if (!IsCollapsed && accountsExpanded)
            {
                <ul id="accounts-submenu" class="nav-subitems" role="list">
                    <li>
                        <NavLink class="nav-item nav-subitem" href="accounts" Match="NavLinkMatch.All" title="All Accounts" aria-label="All Accounts">
                            <span class="nav-icon" aria-hidden="true"><Icon Name="list" Size="16" /></span>
                            <span class="nav-text">All Accounts</span>
                        </NavLink>
                    </li>
                    @foreach (var account in accounts)
                    {
                        <li>
                            <NavLink class="nav-item nav-subitem" href="@($"accounts/{account.Id}/transactions")" title="@account.Name" aria-label="@($"View {account.Name} transactions")">
                                <span class="nav-icon" aria-hidden="true"><Icon Name="credit-card" Size="16" /></span>
                                <span class="nav-text">@TruncateName(account.Name)</span>
                            </NavLink>
                        </li>
                    }
                </ul>
            }
        </li>

        <li>
            <NavLink class="nav-item" href="import" title="Import Transactions" aria-label="Import Transactions">
                <span class="nav-icon" aria-hidden="true"><Icon Name="upload" Size="20" /></span>
                @if (!IsCollapsed)
                {
                    <span class="nav-text">Import</span>
                }
            </NavLink>
        </li>
    </ul>

    <div class="nav-footer" role="list">
        @if (AiAvailability.IsEnabled)
        {
            <div class="nav-section @(AiAvailability.State == AiAvailabilityState.Unavailable ? "ai-unavailable" : "")">
                <button class="nav-item nav-section-toggle"
                        @onclick="ToggleAiToolsSection"
                        title="@GetAiToolsTooltip()"
                        aria-expanded="@aiToolsExpanded"
                        aria-controls="ai-tools-submenu">
                    <span class="nav-icon" aria-hidden="true"><Icon Name="sparkles" Size="20" /></span>
                    @if (!IsCollapsed)
                    {
                        <span class="nav-text">AI Tools</span>
                        @if (AiAvailability.State == AiAvailabilityState.Unavailable)
                        {
                            <span class="nav-warning-icon" title="@AiAvailability.ErrorMessage" aria-hidden="true">
                                <Icon Name="alert-triangle" Size="14" />
                            </span>
                        }
                        <span class="nav-chevron @(aiToolsExpanded ? "expanded" : "")" aria-hidden="true">
                            <Icon Name="chevron-down" Size="16" />
                        </span>
                    }
                </button>

                @if (!IsCollapsed && aiToolsExpanded)
                {
                    <ul id="ai-tools-submenu" class="nav-subitems" role="list">
                        <li>
                            <NavLink class="nav-item nav-subitem" href="ai/suggestions" title="Smart Insights" aria-label="AI Smart Insights">
                                <span class="nav-icon" aria-hidden="true"><Icon Name="lightbulb" Size="16" /></span>
                                <span class="nav-text">Smart Insights</span>
                            </NavLink>
                        </li>
                        <li>
                            <NavLink class="nav-item nav-subitem" href="category-suggestions" title="Category Suggestions" aria-label="AI Category Suggestions">
                                <span class="nav-icon" aria-hidden="true"><Icon Name="tag" Size="16" /></span>
                                <span class="nav-text">Category Suggestions</span>
                            </NavLink>
                        </li>
                    </ul>
                }
            </div>
        }

        <NavLink class="nav-item" href="settings" title="Settings" aria-label="Application Settings">
            <span class="nav-icon" aria-hidden="true"><Icon Name="settings" Size="20" /></span>
            @if (!IsCollapsed)
            {
                <span class="nav-text">Settings</span>
            }
        </NavLink>
    </div>
</nav>

@code {
    /// <summary>
    /// Gets or sets a value indicating whether the menu is collapsed.
    /// </summary>
    [Parameter]
    public bool IsCollapsed { get; set; }

    private const string ReportsExpandedStorageKey = "budget-experiment-reports-expanded";
    private const string AccountsExpandedStorageKey = "budget-experiment-accounts-expanded";
    private const string AiToolsExpandedStorageKey = "budget-experiment-ai-tools-expanded";

    private List<AccountDto> accounts = new();
    private bool isAuthenticated;
    private bool reportsExpanded;
    private bool accountsExpanded = true;
    private bool aiToolsExpanded = true;
    private bool hasLoadedState;

    private async Task ToggleReportsSection()
    {
        reportsExpanded = !reportsExpanded;
        await SaveExpandedStateAsync(ReportsExpandedStorageKey, reportsExpanded);
    }

    private async Task ToggleAccountsSection()
    {
        accountsExpanded = !accountsExpanded;
        await SaveExpandedStateAsync(AccountsExpandedStorageKey, accountsExpanded);
    }

    private async Task ToggleAiToolsSection()
    {
        aiToolsExpanded = !aiToolsExpanded;
        await SaveExpandedStateAsync(AiToolsExpandedStorageKey, aiToolsExpanded);
    }

    private async Task SaveExpandedStateAsync(string key, bool value)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", key, value.ToString().ToLowerInvariant());
        }
        catch
        {
            // Ignore storage errors
        }
    }

    /// <inheritdoc/>
    protected override async Task OnInitializedAsync()
    {
        AuthStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;
        AiAvailability.StatusChanged += OnAiStatusChanged;

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        isAuthenticated = authState.User.Identity?.IsAuthenticated == true;

        if (isAuthenticated)
        {
            await LoadAccountsAsync();
            await AiAvailability.RefreshAsync();
        }
    }

    /// <inheritdoc/>
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !hasLoadedState)
        {
            hasLoadedState = true;
            try
            {
                var reportsState = await JSRuntime.InvokeAsync<string?>("sessionStorage.getItem", ReportsExpandedStorageKey);
                if (bool.TryParse(reportsState, out var reports))
                {
                    reportsExpanded = reports;
                }

                var accountsState = await JSRuntime.InvokeAsync<string?>("sessionStorage.getItem", AccountsExpandedStorageKey);
                if (bool.TryParse(accountsState, out var accts))
                {
                    accountsExpanded = accts;
                }

                var aiToolsState = await JSRuntime.InvokeAsync<string?>("sessionStorage.getItem", AiToolsExpandedStorageKey);
                if (bool.TryParse(aiToolsState, out var aiTools))
                {
                    aiToolsExpanded = aiTools;
                }

                StateHasChanged();
            }
            catch
            {
                // Ignore storage errors - use default state
            }
        }
    }

    private async void OnAuthenticationStateChanged(Task<AuthenticationState> authStateTask)
    {
        var authState = await authStateTask;
        var wasAuthenticated = isAuthenticated;
        isAuthenticated = authState.User.Identity?.IsAuthenticated == true;

        // Reload accounts when user becomes authenticated
        if (isAuthenticated && !wasAuthenticated)
        {
            await LoadAccountsAsync();
            await InvokeAsync(StateHasChanged);
        }
        else if (!isAuthenticated && wasAuthenticated)
        {
            // Clear accounts when user logs out
            accounts = new List<AccountDto>();
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task LoadAccountsAsync()
    {
        try
        {
            var result = await ApiService.GetAccountsAsync();
            accounts = result.ToList();
        }
        catch
        {
            // Silently fail - nav will just show without account links
            accounts = new List<AccountDto>();
        }
    }

    private void OnAiStatusChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private string GetAiToolsTooltip()
    {
        return AiAvailability.State switch
        {
            AiAvailabilityState.Unavailable => $"AI Tools (unavailable: {AiAvailability.ErrorMessage})",
            _ => "AI Tools",
        };
    }

    /// <inheritdoc/>
    public void Dispose()
    {
        AuthStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
        AiAvailability.StatusChanged -= OnAiStatusChanged;
    }

    private static string TruncateName(string name)
    {
        const int maxLength = 15;
        return name.Length <= maxLength ? name : name[..(maxLength - 2)] + "..";
    }
}
