@* NavMenu.razor - Collapsible side navigation menu *@

@using Microsoft.AspNetCore.Components.Authorization

@inject IBudgetApiService ApiService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider

@implements IDisposable

<nav class="nav-menu @(IsCollapsed ? "collapsed" : "expanded")">
    <ScopeSwitcher IsCollapsed="@IsCollapsed" />

    <div class="nav-items">
        <NavLink class="nav-item" href="" Match="NavLinkMatch.All" title="Calendar">
            <span class="nav-icon"><Icon Name="calendar" Size="20" /></span>
            @if (!IsCollapsed)
            {
                <span class="nav-text">Calendar</span>
            }
        </NavLink>

        <NavLink class="nav-item" href="recurring" title="Recurring Transactions">
            <span class="nav-icon"><Icon Name="refresh" Size="20" /></span>
            @if (!IsCollapsed)
            {
                <span class="nav-text">Recurring</span>
            }
        </NavLink>

        <NavLink class="nav-item" href="recurring-transfers" title="Recurring Transfers">
            <span class="nav-icon"><Icon Name="repeat" Size="20" /></span>
            @if (!IsCollapsed)
            {
                <span class="nav-text">Recurring Transfers</span>
            }
        </NavLink>

        <NavLink class="nav-item" href="transfers" title="Transfers">
            <span class="nav-icon"><Icon Name="arrows-horizontal" Size="20" /></span>
            @if (!IsCollapsed)
            {
                <span class="nav-text">Transfers</span>
            }
        </NavLink>

        <NavLink class="nav-item" href="paycheck-planner" title="Paycheck Planner">
            <span class="nav-icon"><Icon Name="calculator" Size="20" /></span>
            @if (!IsCollapsed)
            {
                <span class="nav-text">Paycheck Planner</span>
            }
        </NavLink>

        <NavLink class="nav-item" href="categories" title="Budget Categories">
            <span class="nav-icon"><Icon Name="tag" Size="20" /></span>
            @if (!IsCollapsed)
            {
                <span class="nav-text">Categories</span>
            }
        </NavLink>

        <NavLink class="nav-item" href="rules" title="Categorization Rules">
            <span class="nav-icon"><Icon Name="filter" Size="20" /></span>
            @if (!IsCollapsed)
            {
                <span class="nav-text">Rules</span>
            }
        </NavLink>

        <NavLink class="nav-item" href="budget" title="Budget Overview">
            <span class="nav-icon"><Icon Name="pie-chart" Size="20" /></span>
            @if (!IsCollapsed)
            {
                <span class="nav-text">Budget</span>
            }
        </NavLink>

        <div class="nav-section">
            <NavLink class="nav-item" href="accounts" title="Accounts">
                <span class="nav-icon"><Icon Name="bank" Size="20" /></span>
                @if (!IsCollapsed)
                {
                    <span class="nav-text">Accounts</span>
                }
            </NavLink>

            @if (!IsCollapsed && accounts.Count > 0)
            {
                <div class="nav-subitems">
                    @foreach (var account in accounts)
                    {
                        <NavLink class="nav-item nav-subitem" href="@($"accounts/{account.Id}/transactions")" title="@account.Name">
                            <span class="nav-icon"><Icon Name="credit-card" Size="16" /></span>
                            <span class="nav-text">@TruncateName(account.Name)</span>
                        </NavLink>
                    }
                </div>
            }
        </div>
    </div>

    <div class="nav-footer">
        <NavLink class="nav-item" href="ai/suggestions" title="AI Suggestions">
            <span class="nav-icon"><Icon Name="lightbulb" Size="20" /></span>
            @if (!IsCollapsed)
            {
                <span class="nav-text">AI Suggestions</span>
            }
        </NavLink>

        <NavLink class="nav-item" href="ai/settings" title="AI Settings">
            <span class="nav-icon"><Icon Name="sparkles" Size="20" /></span>
            @if (!IsCollapsed)
            {
                <span class="nav-text">AI Settings</span>
            }
        </NavLink>

        <NavLink class="nav-item" href="settings" title="Settings">
            <span class="nav-icon"><Icon Name="settings" Size="20" /></span>
            @if (!IsCollapsed)
            {
                <span class="nav-text">Settings</span>
            }
        </NavLink>
    </div>
</nav>

@code {
    /// <summary>
    /// Gets or sets a value indicating whether the menu is collapsed.
    /// </summary>
    [Parameter]
    public bool IsCollapsed { get; set; }

    private List<AccountDto> accounts = new();
    private bool isAuthenticated;

    /// <inheritdoc/>
    protected override async Task OnInitializedAsync()
    {
        AuthStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;

        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        isAuthenticated = authState.User.Identity?.IsAuthenticated == true;

        if (isAuthenticated)
        {
            await LoadAccountsAsync();
        }
    }

    private async void OnAuthenticationStateChanged(Task<AuthenticationState> authStateTask)
    {
        var authState = await authStateTask;
        var wasAuthenticated = isAuthenticated;
        isAuthenticated = authState.User.Identity?.IsAuthenticated == true;

        // Reload accounts when user becomes authenticated
        if (isAuthenticated && !wasAuthenticated)
        {
            await LoadAccountsAsync();
            await InvokeAsync(StateHasChanged);
        }
        else if (!isAuthenticated && wasAuthenticated)
        {
            // Clear accounts when user logs out
            accounts = new List<AccountDto>();
            await InvokeAsync(StateHasChanged);
        }
    }

    private async Task LoadAccountsAsync()
    {
        try
        {
            var result = await ApiService.GetAccountsAsync();
            accounts = result.ToList();
        }
        catch
        {
            // Silently fail - nav will just show without account links
            accounts = new List<AccountDto>();
        }
    }

    /// <inheritdoc/>
    public void Dispose()
    {
        AuthStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
    }

    private static string TruncateName(string name)
    {
        const int maxLength = 15;
        return name.Length <= maxLength ? name : name[..(maxLength - 2)] + "..";
    }
}
