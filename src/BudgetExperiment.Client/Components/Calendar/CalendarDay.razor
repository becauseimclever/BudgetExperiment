@* CalendarDay.razor - Individual calendar day cell component *@

<div class="calendar-day @CssClasses"
     @onclick="HandleClick"
     role="button"
     tabindex="0"
     aria-label="@GetAriaLabel()"
     aria-selected="@IsSelected.ToString().ToLowerInvariant()">
    <span class="day-number">
        @Day.Date.Day
        @if (Day.IsToday)
        {
            <span class="sr-only">(Today)</span>
        }
    </span>
    @if (Day.TransactionCount > 0)
    {
        <div class="day-total">
            <MoneyDisplay Amount="@Day.ActualTotal.Amount" />
        </div>
        <div class="transaction-count">
            @Day.TransactionCount txn@(Day.TransactionCount != 1 ? "s" : "")
        </div>
    }
    @if (Day.HasRecurring)
    {
        <div class="recurring-indicator" title="@Day.RecurringCount scheduled">
            <Icon Name="refresh" Size="12" Class="recurring-icon" />
            <span class="recurring-total @(Day.ProjectedTotal.Amount >= 0 ? "positive" : "negative")">
                @FormatRecurringTotal(Day.ProjectedTotal.Amount)
            </span>
        </div>
    }
    <div class="day-balance @(Day.IsBalanceNegative ? "negative" : "")">
        <MoneyDisplay Amount="@Day.EndOfDayBalance.Amount" />
    </div>
</div>

@code {
    /// <summary>
    /// The calendar day data to display.
    /// </summary>
    [Parameter, EditorRequired]
    public CalendarDaySummaryDto Day { get; set; } = default!;

    /// <summary>
    /// Whether this day is currently selected.
    /// </summary>
    [Parameter]
    public bool IsSelected { get; set; }

    /// <summary>
    /// Callback when the day is clicked.
    /// </summary>
    [Parameter]
    public EventCallback<DateOnly> OnClick { get; set; }

    private string CssClasses
    {
        get
        {
            var classes = new List<string>();
            if (!Day.IsCurrentMonth) classes.Add("other-month");
            if (Day.IsToday) classes.Add("today");
            if (IsSelected) classes.Add("selected");
            if (Day.HasRecurring) classes.Add("has-recurring");
            if (Day.IsBalanceNegative) classes.Add("balance-negative");
            return string.Join(" ", classes);
        }
    }

    private async Task HandleClick()
    {
        await OnClick.InvokeAsync(Day.Date);
    }

    private static string FormatRecurringTotal(decimal amount)
    {
        var sign = amount >= 0 ? "+" : "-";
        return $"{sign}${Math.Abs(amount):N0}";
    }

    private string GetAriaLabel()
    {
        var label = Day.Date.ToString("MMMM d, yyyy");
        if (Day.IsToday)
        {
            label += ", Today";
        }

        if (Day.TransactionCount > 0)
        {
            label += $", {Day.TransactionCount} transaction{(Day.TransactionCount != 1 ? "s" : "")}";
        }

        return label;
    }
}
