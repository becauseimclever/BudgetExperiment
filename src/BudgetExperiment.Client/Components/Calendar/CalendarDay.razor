@* CalendarDay.razor - Individual calendar day cell component *@

@using BudgetExperiment.Client.Models

<div class="calendar-day @CssClasses" @onclick="HandleClick">
    <span class="day-number">@Day.Date.Day</span>
    @if (Day.DailyTotal != null)
    {
        <div class="day-total">
            <MoneyDisplay Amount="@Day.DailyTotal.Total.Amount" />
        </div>
        <div class="transaction-count">
            @Day.DailyTotal.TransactionCount txn@(Day.DailyTotal.TransactionCount != 1 ? "s" : "")
        </div>
    }
    @if (Day.HasRecurring)
    {
        <div class="recurring-indicator" title="@Day.RecurringInstances.Count scheduled">
            <span class="recurring-icon">ðŸ”„</span>
            <span class="recurring-total @(Day.RecurringTotal >= 0 ? "positive" : "negative")">
                @FormatRecurringTotal(Day.RecurringTotal)
            </span>
        </div>
    }
</div>

@code {
    /// <summary>
    /// The calendar day data to display.
    /// </summary>
    [Parameter, EditorRequired]
    public CalendarDayModel Day { get; set; } = default!;

    /// <summary>
    /// Whether this day is currently selected.
    /// </summary>
    [Parameter]
    public bool IsSelected { get; set; }

    /// <summary>
    /// Callback when the day is clicked.
    /// </summary>
    [Parameter]
    public EventCallback<DateOnly> OnClick { get; set; }

    private string CssClasses
    {
        get
        {
            var classes = new List<string>();
            if (!Day.IsCurrentMonth) classes.Add("other-month");
            if (Day.IsToday) classes.Add("today");
            if (IsSelected) classes.Add("selected");
            if (Day.HasRecurring) classes.Add("has-recurring");
            return string.Join(" ", classes);
        }
    }

    private async Task HandleClick()
    {
        await OnClick.InvokeAsync(Day.Date);
    }

    private static string FormatRecurringTotal(decimal amount)
    {
        var sign = amount >= 0 ? "+" : "-";
        return $"{sign}${Math.Abs(amount):N0}";
    }
}
