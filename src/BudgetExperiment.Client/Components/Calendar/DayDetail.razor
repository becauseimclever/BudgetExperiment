@* DayDetail.razor - Selected day transaction detail panel *@

<div class="day-detail">
    <h3>Transactions for @Detail.Date.ToString("MMMM d, yyyy")</h3>
    <button class="add-button" @onclick="HandleAddClick">+ Add Transaction</button>

    @{
        var recurringItems = Detail.Items.Where(i => i.Type == "recurring" && !i.IsSkipped).ToList();
        var transactionItems = Detail.Items.Where(i => i.Type != "recurring").ToList();
    }

    @if (recurringItems.Count > 0)
    {
        <div class="recurring-section">
            <h4 class="section-title"><Icon Name="recurring" Size="16" Class="icon-recurring" /> Scheduled Recurring</h4>
            <div class="recurring-list">
                @foreach (var item in recurringItems)
                {
                    <div class="recurring-item @(item.IsModified ? "modified" : "")" @onclick="() => SelectItem(item)">
                        <div class="recurring-info">
                            <span class="recurring-description">@item.Description</span>
                            <span class="recurring-account">@item.AccountName</span>
                        </div>
                        <div class="recurring-right">
                            <span class="recurring-amount @(item.Amount.Amount >= 0 ? "positive" : "negative")">
                                @FormatAmount(item.Amount.Amount)
                            </span>
                            <div class="recurring-actions">
                                <button class="btn-icon" @onclick="() => HandleEditInstance(item)" @onclick:stopPropagation="true" title="Edit this occurrence"><Icon Name="edit" Size="16" /></button>
                                <button class="btn-icon btn-skip" @onclick="() => HandleSkipInstance(item)" @onclick:stopPropagation="true" title="Skip this occurrence"><Icon Name="skip-forward" Size="16" /></button>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <div class="transactions-section">
        @if (recurringItems.Count > 0)
        {
            <h4 class="section-title"><Icon Name="wallet" Size="16" /> Actual Transactions</h4>
        }
        @if (transactionItems.Count > 0)
        {
            <div class="transaction-list">
                @foreach (var item in transactionItems)
                {
                    <div class="transaction-item">
                        <div class="transaction-info">
                            <span class="transaction-description">@item.Description</span>
                            <span class="transaction-account">@item.AccountName</span>
                        </div>
                        <span class="transaction-amount @(item.Amount.Amount >= 0 ? "positive" : "negative")">
                            @FormatAmount(item.Amount.Amount)
                        </span>
                    </div>
                }
            </div>
        }
        else
        {
            <p class="empty-message">No transactions for this day.</p>
        }
    </div>

    @if (Detail.Items.Count > 0)
    {
        <div class="day-summary">
            <div class="summary-row">
                <span>Actual:</span>
                <span class="@(Detail.Summary.TotalActual.Amount >= 0 ? "positive" : "negative")">
                    @FormatAmount(Detail.Summary.TotalActual.Amount)
                </span>
            </div>
            @if (recurringItems.Count > 0)
            {
                <div class="summary-row">
                    <span>Projected:</span>
                    <span class="@(Detail.Summary.TotalProjected.Amount >= 0 ? "positive" : "negative")">
                        @FormatAmount(Detail.Summary.TotalProjected.Amount)
                    </span>
                </div>
            }
            <div class="summary-row total">
                <span>Combined:</span>
                <span class="@(Detail.Summary.CombinedTotal.Amount >= 0 ? "positive" : "negative")">
                    @FormatAmount(Detail.Summary.CombinedTotal.Amount)
                </span>
            </div>
        </div>
    }
</div>

@code {
    /// <summary>
    /// The day detail data from the API.
    /// </summary>
    [Parameter, EditorRequired]
    public DayDetailDto Detail { get; set; } = new();

    /// <summary>
    /// Callback when the Add Transaction button is clicked.
    /// </summary>
    [Parameter]
    public EventCallback OnAddTransaction { get; set; }

    /// <summary>
    /// Callback when a recurring instance edit is requested.
    /// </summary>
    [Parameter]
    public EventCallback<DayDetailItemDto> OnEditInstance { get; set; }

    /// <summary>
    /// Callback when a recurring instance skip is requested.
    /// </summary>
    [Parameter]
    public EventCallback<DayDetailItemDto> OnSkipInstance { get; set; }

    private async Task HandleAddClick()
    {
        await OnAddTransaction.InvokeAsync();
    }

    private void SelectItem(DayDetailItemDto item)
    {
        // Could expand for future detailed view
    }

    private async Task HandleEditInstance(DayDetailItemDto item)
    {
        await OnEditInstance.InvokeAsync(item);
    }

    private async Task HandleSkipInstance(DayDetailItemDto item)
    {
        await OnSkipInstance.InvokeAsync(item);
    }

    private static string FormatAmount(decimal amount)
    {
        var sign = amount >= 0 ? "+" : "";
        return $"{sign}${Math.Abs(amount):N2}";
    }
}
