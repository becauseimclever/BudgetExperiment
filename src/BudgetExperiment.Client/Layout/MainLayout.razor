@inherits LayoutComponentBase

@using BudgetExperiment.Client.Components
@using BudgetExperiment.Client.Components.Auth
@using BudgetExperiment.Client.Components.Chat
@using BudgetExperiment.Client.Components.Navigation
@using BudgetExperiment.Client.Components.Common
@using BudgetExperiment.Client.Components.Forms
@using BudgetExperiment.Client.Services
@inject IAiAvailabilityService AiAvailability
@inject IBudgetApiService ApiService
@inject IToastService ToastService
@inject IJSRuntime JSRuntime
@inject NavigationManager NavigationManager

@implements IDisposable

@* Skip link for keyboard users to bypass navigation *@
<a href="#main-content" class="skip-link">Skip to main content</a>

@* AuthInitializer guarantees user is authenticated before MainLayout renders *@
<div class="app-shell @(chatOpen ? "chat-open" : "")" role="application">
    <header class="app-top-header" role="banner">
        <button class="app-menu-toggle"
                @onclick="ToggleNavigation"
                title="@(navCollapsed ? "Expand menu" : "Collapse menu")"
                aria-label="@(navCollapsed ? "Expand navigation menu" : "Collapse navigation menu")"
                aria-expanded="@(!navCollapsed)">
            <Icon Name="menu" Size="24" />
        </button>
        <a href="/" class="app-brand" aria-label="Budget Experiment - Home">Budget Experiment</a>
        <div class="app-header-spacer"></div>
        @if (AiAvailability.IsEnabled)
        {
            <button class="btn btn-ghost chat-toggle-btn @(AiAvailability.State == AiAvailabilityState.Unavailable ? "ai-unavailable" : "")"
                    @onclick="ToggleChat"
                    title="@GetChatButtonTooltip()"
                    aria-label="@GetChatButtonTooltip()"
                    aria-expanded="@chatOpen">
                <Icon Name="message-circle" Size="20" />
                @if (AiAvailability.State == AiAvailabilityState.Unavailable)
                {
                    <span class="ai-warning-badge" aria-hidden="true">
                        <Icon Name="alert-triangle" Size="12" />
                    </span>
                }
                @if (!chatOpen)
                {
                    <span class="chat-toggle-label">AI Assistant</span>
                }
            </button>
        }
        <ThemeToggle />
        <UserProfile />
    </header>

    <div class="app-content-wrapper">
        <aside class="app-sidebar @(navCollapsed ? "collapsed" : "expanded")" role="navigation" aria-label="Main navigation">
            <NavMenu IsCollapsed="@navCollapsed" />
        </aside>

        <main id="main-content" class="app-main-content" role="main" tabindex="-1">
            @Body
        </main>

        @if (AiAvailability.IsEnabled)
        {
            <ChatPanel IsOpen="@chatOpen" OnToggle="ToggleChat" />
        }
    </div>

    @* Mobile Floating Action Button *@
    <MobileFab @bind-IsExpanded="fabExpanded"
               IsHidden="@(quickAddOpen || mobileChatOpen)"
               ShowAiButton="@AiAvailability.IsEnabled"
               IsAiUnavailable="@(AiAvailability.State == AiAvailabilityState.Unavailable)"
               OnQuickAddClick="OnFabQuickAdd"
               OnAiClick="OnFabAiClick" />

    @* Quick Add Bottom Sheet *@
    <BottomSheet IsVisible="@quickAddOpen"
                 Title="Quick Add Transaction"
                 Height="BottomSheetHeight.Large"
                 OnClose="CloseQuickAdd">
        <QuickAddForm Accounts="@quickAddAccounts"
                      Categories="@quickAddCategories"
                      OnSubmit="HandleQuickAddSubmitAsync"
                      OnCancel="CloseQuickAdd"
                      IsSubmitting="@quickAddSubmitting"
                      ErrorMessage="@quickAddError"
                      @ref="quickAddFormRef" />
    </BottomSheet>

    @* Mobile AI Chat Bottom Sheet *@
    @if (AiAvailability.IsEnabled)
    {
        <MobileChatSheet IsVisible="@mobileChatOpen" OnClose="CloseMobileChat" />
    }

    @* Toast Notifications *@
    <ToastContainer />
</div>

@code {
    private const string NavCollapsedStorageKey = "budget-experiment-nav-collapsed";
    private bool navCollapsed = false;
    private bool chatOpen = false;
    private bool fabExpanded = false;
    private bool hasLoadedState = false;
    private bool quickAddOpen = false;
    private bool quickAddSubmitting = false;
    private bool mobileChatOpen = false;
    private string? quickAddError;
    private IReadOnlyList<AccountDto> quickAddAccounts = Array.Empty<AccountDto>();
    private IReadOnlyList<BudgetCategoryDto> quickAddCategories = Array.Empty<BudgetCategoryDto>();
    private QuickAddForm? quickAddFormRef;

    /// <inheritdoc />
    protected override void OnInitialized()
    {
        AiAvailability.StatusChanged += OnAiStatusChanged;
    }

    /// <inheritdoc />
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !hasLoadedState)
        {
            hasLoadedState = true;
            try
            {
                var savedState = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", NavCollapsedStorageKey);
                if (bool.TryParse(savedState, out var collapsed))
                {
                    navCollapsed = collapsed;
                    StateHasChanged();
                }
            }
            catch
            {
                // Ignore storage errors - use default state
            }
        }
    }

    private async Task ToggleNavigation()
    {
        navCollapsed = !navCollapsed;

        try
        {
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", NavCollapsedStorageKey, navCollapsed.ToString().ToLowerInvariant());
        }
        catch
        {
            // Ignore storage errors
        }
    }

    private void ToggleChat()
    {
        chatOpen = !chatOpen;
    }

    private void OnAiStatusChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private string GetChatButtonTooltip()
    {
        if (AiAvailability.State == AiAvailabilityState.Unavailable)
        {
            return $"AI Assistant (unavailable: {AiAvailability.ErrorMessage})";
        }

        return chatOpen ? "Close chat" : "Open AI Assistant";
    }

    private async Task OnFabQuickAdd()
    {
        quickAddError = null;
        quickAddSubmitting = false;

        try
        {
            var accountsTask = ApiService.GetAccountsAsync();
            var categoriesTask = ApiService.GetCategoriesAsync(activeOnly: true);
            await Task.WhenAll(accountsTask, categoriesTask);

            quickAddAccounts = await accountsTask;
            quickAddCategories = await categoriesTask;
        }
        catch
        {
            quickAddAccounts = Array.Empty<AccountDto>();
            quickAddCategories = Array.Empty<BudgetCategoryDto>();
        }

        quickAddFormRef?.Reset();
        quickAddOpen = true;
    }

    private void CloseQuickAdd()
    {
        quickAddOpen = false;
        quickAddError = null;
    }

    private async Task HandleQuickAddSubmitAsync(TransactionCreateDto transaction)
    {
        quickAddSubmitting = true;
        quickAddError = null;
        StateHasChanged();

        try
        {
            var result = await ApiService.CreateTransactionAsync(transaction);
            if (result != null)
            {
                quickAddOpen = false;
                ToastService.ShowSuccess("Transaction added successfully.");
            }
            else
            {
                quickAddError = "Failed to create transaction. Please try again.";
            }
        }
        catch
        {
            quickAddError = "An unexpected error occurred. Please try again.";
        }
        finally
        {
            quickAddSubmitting = false;
        }
    }

    private void OnFabAiClick()
    {
        // Open the mobile chat bottom sheet (FAB is mobile-only)
        mobileChatOpen = true;
    }

    private void CloseMobileChat()
    {
        mobileChatOpen = false;
    }

    /// <inheritdoc />
    public void Dispose()
    {
        AiAvailability.StatusChanged -= OnAiStatusChanged;
    }
}
