@inherits LayoutComponentBase

@using BudgetExperiment.Client.Components.Auth
@using BudgetExperiment.Client.Components.Chat
@using BudgetExperiment.Client.Components.Navigation
@using BudgetExperiment.Client.Components.Common
@using BudgetExperiment.Client.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthStateProvider
@inject IJSRuntime JSRuntime

<AuthorizeView>
    <Authorized>
        <div class="app-shell @(chatOpen ? "chat-open" : "")">
            <header class="app-top-header">
                <button class="app-menu-toggle" @onclick="ToggleNavigation" title="@(navCollapsed ? "Expand menu" : "Collapse menu")">
                    <Icon Name="menu" Size="24" />
                </button>
                <a href="/" class="app-brand">Budget Experiment</a>
                <div class="app-header-spacer"></div>
                <button class="btn btn-ghost chat-toggle-btn" @onclick="ToggleChat" title="@(chatOpen ? "Close chat" : "Open AI Assistant")">
                    <Icon Name="message-circle" Size="20" />
                    @if (!chatOpen)
                    {
                        <span class="chat-toggle-label">AI Assistant</span>
                    }
                </button>
                <ThemeToggle />
                <UserProfile />
            </header>

            <div class="app-content-wrapper">
                <aside class="app-sidebar @(navCollapsed ? "collapsed" : "expanded")">
                    <NavMenu IsCollapsed="@navCollapsed" />
                </aside>

                <main class="app-main-content">
                    @Body
                </main>

                <ChatPanel IsOpen="@chatOpen" OnToggle="ToggleChat" />
            </div>
        </div>
    </Authorized>
    <Authorizing>
        @* Minimal loading state while checking auth - no API calls *@
        <div class="auth-loading-container">
            <div class="auth-loading-spinner"></div>
            <p>Checking authentication...</p>
        </div>
    </Authorizing>
    <NotAuthorized>
        @* This shouldn't normally show - AuthorizeRouteView handles redirect *@
        @Body
    </NotAuthorized>
</AuthorizeView>

@code {
    private const string NavCollapsedStorageKey = "budget-experiment-nav-collapsed";
    private bool navCollapsed = false;
    private bool chatOpen = false;
    private bool hasLoadedState = false;

    /// <inheritdoc />
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !hasLoadedState)
        {
            hasLoadedState = true;
            try
            {
                var savedState = await JSRuntime.InvokeAsync<string?>("localStorage.getItem", NavCollapsedStorageKey);
                if (bool.TryParse(savedState, out var collapsed))
                {
                    navCollapsed = collapsed;
                    StateHasChanged();
                }
            }
            catch
            {
                // Ignore storage errors - use default state
            }
        }
    }

    private async Task ToggleNavigation()
    {
        navCollapsed = !navCollapsed;

        try
        {
            await JSRuntime.InvokeVoidAsync("localStorage.setItem", NavCollapsedStorageKey, navCollapsed.ToString().ToLowerInvariant());
        }
        catch
        {
            // Ignore storage errors
        }
    }

    private void ToggleChat()
    {
        chatOpen = !chatOpen;
    }
}
