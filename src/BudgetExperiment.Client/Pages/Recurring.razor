@page "/recurring"

@using BudgetExperiment.Domain

@implements IDisposable

@inject IBudgetApiService ApiService
@inject NavigationManager Navigation
@inject ScopeService ScopeService
@inject IChatContextService ChatContext

<PageTitle>Recurring Transactions - Budget Experiment</PageTitle>

<div class="page-container">
    <PageHeader Title="Recurring Transactions">
        <Actions>
            <Button Variant="ButtonVariant.Success" OnClick="ShowAddForm">+ Add Recurring</Button>
        </Actions>
    </PageHeader>

    <ErrorAlert Message="@errorMessage"
                IsDismissible="true"
                IsRetrying="@isRetrying"
                OnRetry="RetryLoad"
                OnDismiss="DismissError" />

    @if (isLoading)
    {
        <LoadingSpinner Message="Loading recurring transactions..." />
    }
    else if (errorMessage != null)
    {
        @* Error is displayed by ErrorAlert above *@
    }
    else if (recurringTransactions.Count == 0)
    {
        <EmptyState Title="No Recurring Transactions"
                   Description="Set up recurring transactions for bills, income, or regular expenses."
                   Icon="refresh">
            <Button Variant="ButtonVariant.Primary" OnClick="ShowAddForm">Create Your First Recurring Transaction</Button>
        </EmptyState>
    }
    else
    {
        <div class="recurring-list">
            @foreach (var recurring in recurringTransactions)
            {
                <div class="recurring-card @(recurring.IsActive ? "" : "inactive")">
                    <div class="recurring-card-header">
                        <div class="recurring-card-info">
                            <h3 class="recurring-card-title">@recurring.Description</h3>
                            <div class="badge-group">
                                <span class="badge badge-account">@recurring.AccountName</span>
                                <span class="badge badge-frequency">@FormatFrequency(recurring)</span>
                                @if (recurring.CategoryId.HasValue)
                                {
                                    <span class="badge badge-category">@recurring.CategoryId.ToString()![..8]</span>
                                }
                            </div>
                        </div>
                        <div class="recurring-card-amount @(recurring.Amount.Amount >= 0 ? "positive" : "negative")">
                            @FormatMoney(recurring.Amount)
                        </div>
                    </div>
                    <div class="detail-list">
                        <div class="detail-item">
                            <span class="detail-label">Next:</span>
                            <span class="detail-value">@recurring.NextOccurrence.ToString("MMM d, yyyy")</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Started:</span>
                            <span class="detail-value">@recurring.StartDate.ToString("MMM d, yyyy")</span>
                        </div>
                        @if (recurring.EndDate.HasValue)
                        {
                            <div class="detail-item">
                                <span class="detail-label">Ends:</span>
                                <span class="detail-value">@recurring.EndDate.Value.ToString("MMM d, yyyy")</span>
                            </div>
                        }
                        <div class="detail-item">
                            <span class="detail-label">Status:</span>
                            <span class="badge-status @(recurring.IsActive ? "badge-status-active" : "badge-status-paused")">
                                @(recurring.IsActive ? "Active" : "Paused")
                            </span>
                        </div>
                    </div>
                    <div class="recurring-card-actions">
                        @if (recurring.IsActive)
                        {
                            <button class="btn-action" @onclick="() => SkipNext(recurring)" title="Skip next occurrence">
                                <Icon Name="skip-forward" Size="16" /> Skip
                            </button>
                            <button class="btn-action" @onclick="() => Pause(recurring)" title="Pause">
                                <Icon Name="pause" Size="16" /> Pause
                            </button>
                        }
                        else
                        {
                            <button class="btn-action btn-action-resume" @onclick="() => Resume(recurring)" title="Resume">
                                <Icon Name="play" Size="16" /> Resume
                            </button>
                        }
                        <button class="btn-action" @onclick="() => ShowImportPatterns(recurring)" title="Import Patterns">
                            <Icon Name="filter" Size="16" /> Patterns
                        </button>
                        <button class="btn-action btn-action-edit" @onclick="() => ShowEditForm(recurring)" title="Edit">
                            <Icon Name="edit" Size="16" /> Edit
                        </button>
                        <button class="btn-action btn-action-delete" @onclick="() => ShowDeleteConfirm(recurring)" title="Delete">
                            <Icon Name="trash" Size="16" /> Delete
                        </button>
                    </div>
                </div>
            }
        </div>
    }

    <Modal IsVisible="@showAddForm" Title="Add Recurring Transaction" OnClose="HideForm">
        <RecurringTransactionForm Model="@newRecurring"
                                   Categories="@categories"
                                   OnSubmit="CreateRecurring"
                                   OnCancel="HideForm"
                                   IsSubmitting="@isSubmitting" />
    </Modal>

    <Modal IsVisible="@showEditForm" Title="Edit Recurring Transaction" OnClose="HideForm">
        <EditRecurringForm Model="@editModel"
                           Categories="@categories"
                           OnSubmit="UpdateRecurring"
                           OnCancel="HideForm"
                           IsSubmitting="@isSubmitting" />
    </Modal>

    <ConfirmDialog IsVisible="@showDeleteConfirm"
                   Title="Delete Recurring Transaction"
                   Message="@($"Are you sure you want to delete '{deletingRecurring?.Description}'? Future occurrences will no longer be scheduled.")"
                   ConfirmText="Delete"
                   IsProcessing="@isDeleting"
                   OnConfirm="ConfirmDelete"
                   OnCancel="CancelDelete" />

    <ImportPatternsDialog IsVisible="@showImportPatterns"
                          RecurringTransactionId="@importPatternsRecurringId"
                          RecurringDescription="@importPatternsDescription"
                          OnSaved="HandleImportPatternsSaved"
                          OnCancel="HideImportPatterns" />
</div>

@code {
    private bool isLoading = true;
    private bool isRetrying;
    private bool isSubmitting = false;
    private bool isDeleting = false;
    private string? errorMessage;
    private List<RecurringTransactionDto> recurringTransactions = new();
    private List<BudgetCategoryDto> categories = new();

    private bool showAddForm = false;
    private bool showEditForm = false;
    private bool showDeleteConfirm = false;
    private bool showImportPatterns = false;

    private RecurringTransactionCreateDto newRecurring = new();
    private RecurringTransactionUpdateDto editModel = new();
    private Guid editingId;
    private RecurringTransactionDto? deletingRecurring;
    private Guid importPatternsRecurringId;
    private string importPatternsDescription = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        ScopeService.ScopeChanged += OnScopeChanged;
        ChatContext.SetPageType("recurring transactions");
        await LoadRecurringTransactions();
        await LoadCategories();
    }

    private async void OnScopeChanged(BudgetScope? _)
    {
        await InvokeAsync(async () =>
        {
            await LoadRecurringTransactions();
            await LoadCategories();
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        ScopeService.ScopeChanged -= OnScopeChanged;
        ChatContext.ClearContext();
    }

    private async Task LoadCategories()
    {
        try
        {
            categories = (await ApiService.GetCategoriesAsync()).ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load categories: {ex.Message}";
        }
    }

    private async Task LoadRecurringTransactions()
    {
        isLoading = true;
        errorMessage = null;

        try
        {
            recurringTransactions = (await ApiService.GetRecurringTransactionsAsync()).ToList();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load recurring transactions: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RetryLoad()
    {
        isRetrying = true;
        StateHasChanged();

        try
        {
            await LoadRecurringTransactions();
        }
        finally
        {
            isRetrying = false;
        }
    }

    private void DismissError()
    {
        errorMessage = null;
    }

    private void ShowAddForm()
    {
        newRecurring = new RecurringTransactionCreateDto
        {
            Frequency = "Monthly",
            StartDate = DateOnly.FromDateTime(DateTime.Today),
        };
        showAddForm = true;
    }

    private void ShowEditForm(RecurringTransactionDto recurring)
    {
        editingId = recurring.Id;
        editModel = new RecurringTransactionUpdateDto
        {
            Description = recurring.Description,
            Amount = recurring.Amount,
            EndDate = recurring.EndDate,
            CategoryId = recurring.CategoryId,
        };
        showEditForm = true;
    }

    private void HideForm()
    {
        showAddForm = false;
        showEditForm = false;
    }

    private async Task CreateRecurring(RecurringTransactionCreateDto model)
    {
        isSubmitting = true;
        try
        {
            var result = await ApiService.CreateRecurringTransactionAsync(model);
            if (result != null)
            {
                showAddForm = false;
                await LoadRecurringTransactions();
            }
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task UpdateRecurring(RecurringTransactionUpdateDto model)
    {
        isSubmitting = true;
        try
        {
            var result = await ApiService.UpdateRecurringTransactionAsync(editingId, model);
            if (result != null)
            {
                showEditForm = false;
                await LoadRecurringTransactions();
            }
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private async Task SkipNext(RecurringTransactionDto recurring)
    {
        var result = await ApiService.SkipNextRecurringAsync(recurring.Id);
        if (result != null)
        {
            await LoadRecurringTransactions();
        }
    }

    private async Task Pause(RecurringTransactionDto recurring)
    {
        var result = await ApiService.PauseRecurringTransactionAsync(recurring.Id);
        if (result != null)
        {
            await LoadRecurringTransactions();
        }
    }

    private async Task Resume(RecurringTransactionDto recurring)
    {
        var result = await ApiService.ResumeRecurringTransactionAsync(recurring.Id);
        if (result != null)
        {
            await LoadRecurringTransactions();
        }
    }

    private void ShowDeleteConfirm(RecurringTransactionDto recurring)
    {
        deletingRecurring = recurring;
        showDeleteConfirm = true;
    }

    private async Task ConfirmDelete()
    {
        if (deletingRecurring == null)
        {
            return;
        }

        isDeleting = true;
        StateHasChanged();

        try
        {
            var deleted = await ApiService.DeleteRecurringTransactionAsync(deletingRecurring.Id);
            if (deleted)
            {
                showDeleteConfirm = false;
                deletingRecurring = null;
                await LoadRecurringTransactions();
            }
        }
        finally
        {
            isDeleting = false;
        }
    }

    private void CancelDelete()
    {
        showDeleteConfirm = false;
        deletingRecurring = null;
    }

    private void ShowImportPatterns(RecurringTransactionDto recurring)
    {
        importPatternsRecurringId = recurring.Id;
        importPatternsDescription = recurring.Description;
        showImportPatterns = true;
    }

    private void HideImportPatterns()
    {
        showImportPatterns = false;
        importPatternsRecurringId = Guid.Empty;
        importPatternsDescription = string.Empty;
    }

    private void HandleImportPatternsSaved()
    {
        HideImportPatterns();
    }

    private static string FormatFrequency(RecurringTransactionDto recurring)
    {
        return recurring.Frequency switch
        {
            "Daily" => "Daily",
            "Weekly" => $"Weekly on {recurring.DayOfWeek}",
            "BiWeekly" => $"Bi-Weekly on {recurring.DayOfWeek}",
            "Monthly" => recurring.DayOfMonth.HasValue ? $"Monthly on day {recurring.DayOfMonth}" : "Monthly",
            "Quarterly" => recurring.DayOfMonth.HasValue ? $"Quarterly on day {recurring.DayOfMonth}" : "Quarterly",
            "Yearly" => recurring.DayOfMonth.HasValue ? $"Yearly on day {recurring.DayOfMonth}" : "Yearly",
            _ => recurring.Frequency,
        };
    }

    private static string FormatMoney(MoneyDto money)
    {
        var sign = money.Amount >= 0 ? "+" : "";
        return $"{sign}{money.Currency} {money.Amount:N2}";
    }
}
