@page "/accounts"

@using BudgetExperiment.Client.Models
@using BudgetExperiment.Client.Services

@inject IBudgetApiService ApiService
@inject NavigationManager Navigation

<PageTitle>Accounts - Budget Experiment</PageTitle>

<div class="accounts-container">
    <PageHeader Title="Accounts">
        <Actions>
            <button class="add-button" @onclick="ShowAddAccount">+ Add Account</button>
        </Actions>
    </PageHeader>

    @if (isLoading)
    {
        <LoadingSpinner Message="Loading accounts..." />
    }
    else if (accounts.Count == 0)
    {
        <p class="empty-message">No accounts yet. Create one to get started!</p>
    }
    else
    {
        <div class="accounts-grid">
            @foreach (var account in accounts)
            {
                <div class="account-card">
                    <div class="account-info">
                        <h3>@account.Name</h3>
                        <span class="account-type">@account.Type</span>
                    </div>
                    <div class="account-actions">
                        <button class="btn-view" @onclick="() => ViewAccount(account.Id)">Transactions</button>
                        <button class="btn-delete" @onclick="() => DeleteAccount(account.Id)">Delete</button>
                    </div>
                </div>
            }
        </div>
    }

    <Modal IsVisible="@showAddAccount" Title="Add Account" OnClose="HideAddAccount">
        <AccountForm Model="@newAccount"
                     OnSubmit="CreateAccount"
                     OnCancel="HideAddAccount"
                     IsSubmitting="@isSubmitting" />
    </Modal>

    <ConfirmDialog IsVisible="@showDeleteConfirm"
                   Title="Delete Account"
                   Message="@($"Are you sure you want to delete '{deletingAccount?.Name}'? This will also delete all transactions for this account.")"
                   ConfirmText="Delete"
                   IsProcessing="@isDeleting"
                   OnConfirm="ConfirmDelete"
                   OnCancel="CancelDelete" />
</div>

<style>
    .accounts-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
    }

    .empty-message {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }

    .add-button {
        padding: 10px 20px;
        background: #28a745;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .add-button:hover {
        background: #218838;
    }

    .accounts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 20px;
    }

    .account-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .account-info h3 {
        margin: 0 0 8px 0;
    }

    .account-type {
        color: #666;
        font-size: 0.9em;
    }

    .account-actions {
        margin-top: 15px;
        display: flex;
        gap: 10px;
    }

    .btn-view {
        padding: 6px 12px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-view:hover {
        background: #0056b3;
    }

    .btn-delete {
        padding: 6px 12px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }

    .btn-delete:hover {
        background: #c82333;
    }
</style>

@code {
    private bool isLoading = true;
    private bool isSubmitting = false;
    private List<AccountModel> accounts = new();
    private bool showAddAccount = false;
    private AccountCreateModel newAccount = new();

    // Delete confirmation state
    private bool showDeleteConfirm = false;
    private bool isDeleting = false;
    private AccountModel? deletingAccount = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadAccounts();
    }

    private async Task LoadAccounts()
    {
        isLoading = true;
        accounts = (await ApiService.GetAccountsAsync()).ToList();
        isLoading = false;
    }

    private void ShowAddAccount()
    {
        newAccount = new AccountCreateModel { Type = "Checking" };
        showAddAccount = true;
    }

    private void HideAddAccount()
    {
        showAddAccount = false;
    }

    private async Task CreateAccount(AccountCreateModel model)
    {
        isSubmitting = true;
        try
        {
            var result = await ApiService.CreateAccountAsync(model);
            if (result != null)
            {
                showAddAccount = false;
                await LoadAccounts();
            }
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void ViewAccount(Guid id)
    {
        Navigation.NavigateTo($"/accounts/{id}/transactions");
    }

    private void DeleteAccount(Guid id)
    {
        deletingAccount = accounts.FirstOrDefault(a => a.Id == id);
        if (deletingAccount != null)
        {
            showDeleteConfirm = true;
        }
    }

    private async Task ConfirmDelete()
    {
        if (deletingAccount == null)
        {
            return;
        }

        isDeleting = true;
        StateHasChanged();

        try
        {
            var deleted = await ApiService.DeleteAccountAsync(deletingAccount.Id);
            if (deleted)
            {
                showDeleteConfirm = false;
                deletingAccount = null;
                await LoadAccounts();
            }
        }
        finally
        {
            isDeleting = false;
        }
    }

    private void CancelDelete()
    {
        showDeleteConfirm = false;
        deletingAccount = null;
    }
}
