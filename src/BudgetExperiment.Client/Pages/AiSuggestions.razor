@page "/ai/suggestions"
@using BudgetExperiment.Client.Components.AI
@using BudgetExperiment.Client.Components.Common
@using BudgetExperiment.Client.Services
@using BudgetExperiment.Contracts.Dtos
@implements IDisposable
@inject IAiApiService AiService
@inject NavigationManager Navigation

<PageHeader Title="AI Suggestions" Subtitle="Review and manage AI-generated rule suggestions" />

<div class="suggestions-page">
    <div class="suggestions-toolbar">
        <div class="toolbar-left">
            <button class="btn btn-primary" @onclick="StartAnalysis" disabled="@(IsAnalyzing || !IsAiAvailable)">
                <Icon Name="sparkles" Size="16" />
                <span>Run AI Analysis</span>
            </button>

            <button class="btn btn-secondary" @onclick="RefreshSuggestions" disabled="@IsLoading">
                <Icon Name="refresh-cw" Size="16" />
                <span>Refresh</span>
            </button>
        </div>

        <div class="toolbar-right">
            <AiStatusBadge />
        </div>
    </div>

    @if (AnalysisResult != null && !ShowProgressDialog)
    {
        <AnalysisSummaryCard Result="AnalysisResult"
                             OnDismiss="DismissAnalysisSummary"
                             OnViewSuggestions="ScrollToSuggestions" />
    }

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <ErrorAlert Message="@ErrorMessage" OnDismiss="DismissError" />
    }

    @if (!IsLoading && Suggestions.Count == 0 && AnalysisResult == null && Status?.IsAvailable != true)
    {
        <AiOnboardingPanel />
    }
    else
    {
        <SuggestionList Suggestions="Suggestions"
                        IsLoading="IsLoading"
                        OnAccept="HandleAccept"
                        OnDismiss="HandleDismiss"
                        OnFeedback="HandleFeedback"
                        OnViewDetails="HandleViewDetails" />
    }

    <SuggestionDetailDialog IsVisible="SelectedSuggestion != null"
                            Suggestion="SelectedSuggestion"
                            OnClose="CloseDetailDialog"
                            OnAccept="HandleAccept"
                            OnDismiss="HandleDismiss"
                            OnFeedback="HandleFeedback" />

    <AnalysisProgressDialog IsVisible="ShowProgressDialog"
                            IsRunning="IsAnalyzing"
                            Result="AnalysisResult"
                            ErrorMessage="@AnalysisError"
                            CurrentStep="CurrentAnalysisStep"
                            ElapsedTime="AnalysisElapsed"
                            OnClose="CloseProgressDialog"
                            OnCancel="CancelAnalysis"
                            OnRetry="StartAnalysis"
                            OnViewSuggestions="CloseProgressDialogAndScroll" />
</div>

@code {
    private IReadOnlyList<RuleSuggestionDto> Suggestions { get; set; } = Array.Empty<RuleSuggestionDto>();
    private AiStatusDto? Status { get; set; }
    private AnalysisResponseDto? AnalysisResult { get; set; }
    private RuleSuggestionDto? SelectedSuggestion { get; set; }

    private bool IsLoading { get; set; }
    private bool IsAnalyzing { get; set; }
    private bool ShowProgressDialog { get; set; }
    private int CurrentAnalysisStep { get; set; }
    private TimeSpan AnalysisElapsed { get; set; }
    private string? AnalysisError { get; set; }
    private System.Timers.Timer? _elapsedTimer;
    private DateTime _analysisStartTime;

    private bool IsAiAvailable => Status?.IsAvailable == true && Status?.IsEnabled == true;
    private string? ErrorMessage { get; set; }

    /// <inheritdoc />
    protected override async Task OnInitializedAsync()
    {
        await LoadStatusAsync();
        await LoadSuggestionsAsync();
    }

    private async Task LoadStatusAsync()
    {
        try
        {
            Status = await AiService.GetStatusAsync();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Failed to load AI status: {ex.Message}";
        }
    }

    private async Task LoadSuggestionsAsync()
    {
        IsLoading = true;
        ErrorMessage = null;

        try
        {
            Suggestions = await AiService.GetPendingSuggestionsAsync();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Failed to load suggestions: {ex.Message}";
            Suggestions = Array.Empty<RuleSuggestionDto>();
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task RefreshSuggestions()
    {
        await LoadSuggestionsAsync();
    }

    private async Task StartAnalysis()
    {
        if (IsAnalyzing || !IsAiAvailable)
        {
            return;
        }

        // Reset state
        IsAnalyzing = true;
        ShowProgressDialog = true;
        AnalysisResult = null;
        AnalysisError = null;
        CurrentAnalysisStep = 0;
        AnalysisElapsed = TimeSpan.Zero;
        _analysisStartTime = DateTime.UtcNow;

        // Start elapsed timer
        _elapsedTimer = new System.Timers.Timer(1000);
        _elapsedTimer.Elapsed += OnElapsedTick;
        _elapsedTimer.Start();

        StateHasChanged();

        try
        {
            // Simulate step progression (in real implementation, this would be event-driven)
            await SimulateProgressSteps();

            AnalysisResult = await AiService.AnalyzeAsync();

            if (AnalysisResult != null)
            {
                CurrentAnalysisStep = 6; // All complete
                await LoadSuggestionsAsync();
            }
            else
            {
                AnalysisError = "Analysis failed. AI service may be unavailable.";
            }
        }
        catch (Exception ex)
        {
            AnalysisError = $"Analysis failed: {ex.Message}";
        }
        finally
        {
            IsAnalyzing = false;
            StopElapsedTimer();
            StateHasChanged();
        }
    }

    private async Task SimulateProgressSteps()
    {
        // Simulate progress through steps with delays
        for (int i = 0; i < 5; i++)
        {
            CurrentAnalysisStep = i;
            StateHasChanged();
            await Task.Delay(500); // Brief delay to show step progression
        }
    }

    private void OnElapsedTick(object? sender, System.Timers.ElapsedEventArgs e)
    {
        AnalysisElapsed = DateTime.UtcNow - _analysisStartTime;
        InvokeAsync(StateHasChanged);
    }

    private void StopElapsedTimer()
    {
        if (_elapsedTimer != null)
        {
            _elapsedTimer.Stop();
            _elapsedTimer.Elapsed -= OnElapsedTick;
            _elapsedTimer.Dispose();
            _elapsedTimer = null;
        }
    }

    private void CancelAnalysis()
    {
        // Cancel is mostly cosmetic since we can't cancel the HTTP call easily
        IsAnalyzing = false;
        ShowProgressDialog = false;
        StopElapsedTimer();
    }

    private void CloseProgressDialog()
    {
        ShowProgressDialog = false;
    }

    private void CloseProgressDialogAndScroll()
    {
        ShowProgressDialog = false;
        // Scroll handled by page layout automatically
    }

    private void ScrollToSuggestions()
    {
        // Suggestions list is already visible, just dismiss the summary card
    }

    private async Task HandleAccept(Guid id)
    {
        try
        {
            var rule = await AiService.AcceptSuggestionAsync(id);
            if (rule != null)
            {
                // Remove the accepted suggestion from the list
                Suggestions = Suggestions.Where(s => s.Id != id).ToList();

                // Close detail dialog if open
                if (SelectedSuggestion?.Id == id)
                {
                    SelectedSuggestion = null;
                }
            }
            else
            {
                ErrorMessage = "Failed to accept suggestion.";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Failed to accept suggestion: {ex.Message}";
        }
    }

    private async Task HandleDismiss(Guid id)
    {
        try
        {
            var success = await AiService.DismissSuggestionAsync(id);
            if (success)
            {
                // Remove the dismissed suggestion from the list
                Suggestions = Suggestions.Where(s => s.Id != id).ToList();

                // Close detail dialog if open
                if (SelectedSuggestion?.Id == id)
                {
                    SelectedSuggestion = null;
                }
            }
            else
            {
                ErrorMessage = "Failed to dismiss suggestion.";
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Failed to dismiss suggestion: {ex.Message}";
        }
    }

    private async Task HandleFeedback((Guid Id, bool IsPositive) feedback)
    {
        try
        {
            var success = await AiService.ProvideFeedbackAsync(feedback.Id, feedback.IsPositive);
            if (success)
            {
                // Update the local suggestion to reflect feedback
                var suggestion = Suggestions.FirstOrDefault(s => s.Id == feedback.Id);
                if (suggestion != null)
                {
                    // Create a new list with updated feedback (immutable update)
                    Suggestions = Suggestions.Select(s =>
                    {
                        if (s.Id == feedback.Id)
                        {
                            return new RuleSuggestionDto
                            {
                                Id = s.Id,
                                Type = s.Type,
                                Status = s.Status,
                                Title = s.Title,
                                Description = s.Description,
                                Reasoning = s.Reasoning,
                                Confidence = s.Confidence,
                                SuggestedPattern = s.SuggestedPattern,
                                SuggestedMatchType = s.SuggestedMatchType,
                                SuggestedCategoryId = s.SuggestedCategoryId,
                                SuggestedCategoryName = s.SuggestedCategoryName,
                                TargetRuleId = s.TargetRuleId,
                                TargetRuleName = s.TargetRuleName,
                                OptimizedPattern = s.OptimizedPattern,
                                ConflictingRuleIds = s.ConflictingRuleIds,
                                AffectedTransactionCount = s.AffectedTransactionCount,
                                SampleDescriptions = s.SampleDescriptions,
                                CreatedAtUtc = s.CreatedAtUtc,
                                ReviewedAtUtc = s.ReviewedAtUtc,
                                UserFeedbackPositive = feedback.IsPositive,
                            };
                        }

                        return s;
                    }).ToList();

                    // Update selected suggestion if it's the one being updated
                    if (SelectedSuggestion?.Id == feedback.Id)
                    {
                        SelectedSuggestion = Suggestions.FirstOrDefault(s => s.Id == feedback.Id);
                    }
                }
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Failed to submit feedback: {ex.Message}";
        }
    }

    private async Task HandleViewDetails(Guid id)
    {
        try
        {
            SelectedSuggestion = await AiService.GetSuggestionAsync(id);
            if (SelectedSuggestion == null)
            {
                // Fall back to local copy
                SelectedSuggestion = Suggestions.FirstOrDefault(s => s.Id == id);
            }
        }
        catch
        {
            // Fall back to local copy on error
            SelectedSuggestion = Suggestions.FirstOrDefault(s => s.Id == id);
        }
    }

    private void CloseDetailDialog()
    {
        SelectedSuggestion = null;
    }

    private void DismissError()
    {
        ErrorMessage = null;
    }

    private void DismissAnalysisSummary()
    {
        AnalysisResult = null;
    }

    /// <inheritdoc />
    public void Dispose()
    {
        StopElapsedTimer();
    }
}
