@page "/reports/categories"

@using BudgetExperiment.Client.Components.Charts
@using BudgetExperiment.Client.Components.Reports
@using BudgetExperiment.Domain

@implements IDisposable

@inject IBudgetApiService ApiService
@inject NavigationManager Navigation
@inject ScopeService ScopeService

<PageTitle>Category Spending - Budget Experiment</PageTitle>

<div class="page-container">
    <PageHeader Title="Category Spending">
        <Actions>
            <a href="/@DateTime.Today.Year/@DateTime.Today.Month" class="btn-back-calendar" title="Back to Calendar">
                <Icon Name="calendar" Size="16" />
                Calendar
            </a>
        </Actions>
    </PageHeader>

    <DateRangePicker StartDate="@rangeStart"
                     EndDate="@rangeEnd"
                     OnRangeChanged="HandleRangeChanged"
                     ShowPresets="true" />

    <ErrorAlert Message="@errorMessage"
                OnRetry="RetryLoad"
                OnDismiss="DismissError"
                IsRetrying="@isRetrying" />

    @if (isLoading)
    {
        <LoadingSpinner Message="Loading category report..." />
    }
    else if (totalSpending == null && errorMessage == null)
    {
        <div class="empty-state">
            <Icon Name="pie-chart" Size="48" />
            <p>No spending data for the selected period.</p>
            <p class="empty-state-hint">Transactions will appear here once you have spending in categories.</p>
        </div>
    }
    else if (errorMessage == null && totalSpending != null)
    {
        <div class="report-content">
            <div class="chart-section">
                <DonutChart Segments="@chartSegments"
                            CenterValue="@totalSpending.Amount"
                            CenterLabel="Total"
                            Size="320"
                            StrokeWidth="50"
                            OnSegmentClick="HandleSegmentClick"
                            ShowLegend="true" />
            </div>

            <div class="summary-section">
                <div class="summary-card">
                    <h3>Summary</h3>
                    <div class="summary-stats">
                        <div class="summary-stat">
                            <span class="stat-label">Total Spending</span>
                            <span class="stat-value text-expense">
                                <MoneyDisplay Amount="@totalSpending.Amount" CurrencyCode="@totalSpending.Currency" />
                            </span>
                        </div>
                        <div class="summary-stat">
                            <span class="stat-label">Total Income</span>
                            <span class="stat-value text-income">
                                <MoneyDisplay Amount="@totalIncome!.Amount" CurrencyCode="@totalIncome.Currency" />
                            </span>
                        </div>
                        <div class="summary-stat">
                            <span class="stat-label">Net</span>
                            <span class="stat-value @(totalIncome.Amount - totalSpending.Amount >= 0 ? "text-income" : "text-expense")">
                                <MoneyDisplay Amount="@(totalIncome.Amount - totalSpending.Amount)" CurrencyCode="@totalSpending.Currency" />
                            </span>
                        </div>
                        <div class="summary-stat">
                            <span class="stat-label">Categories</span>
                            <span class="stat-value">@categoryList.Count</span>
                        </div>
                    </div>
                </div>

                <div class="categories-list">
                    <h3>Categories</h3>
                    @foreach (var category in categoryList.OrderByDescending(c => c.Amount.Amount))
                    {
                        <div class="category-row" @onclick="() => NavigateToCategory(category.CategoryId)">
                            <span class="category-color" style="background-color: @(category.CategoryColor ?? "#999")"></span>
                            <span class="category-name">@category.CategoryName</span>
                            <span class="category-count">@category.TransactionCount txns</span>
                            <span class="category-percentage">@category.Percentage.ToString("F1")%</span>
                            <span class="category-amount text-expense">
                                <MoneyDisplay Amount="@category.Amount.Amount" CurrencyCode="@category.Amount.Currency" />
                            </span>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    [SupplyParameterFromQuery(Name = "year")]
    public int? QueryYear { get; set; }

    [SupplyParameterFromQuery(Name = "month")]
    public int? QueryMonth { get; set; }

    [SupplyParameterFromQuery(Name = "start")]
    public string? QueryStart { get; set; }

    [SupplyParameterFromQuery(Name = "end")]
    public string? QueryEnd { get; set; }

    private DateOnly rangeStart;
    private DateOnly rangeEnd;
    private List<DonutSegmentData> chartSegments = new();
    private MoneyDto? totalSpending;
    private MoneyDto? totalIncome;
    private IReadOnlyList<CategorySpendingDto> categoryList = [];
    private string? errorMessage;
    private bool isLoading = true;
    private bool isRetrying;

    /// <inheritdoc/>
    protected override async Task OnInitializedAsync()
    {
        InitializeDateRange();
        ScopeService.ScopeChanged += HandleScopeChanged;
        await LoadReportAsync();
    }

    private void InitializeDateRange()
    {
        // Priority: ?year=&month= params > ?start=&end= params > default (this month)
        if (QueryYear.HasValue && QueryMonth.HasValue)
        {
            rangeStart = new DateOnly(QueryYear.Value, QueryMonth.Value, 1);
            rangeEnd = rangeStart.AddMonths(1).AddDays(-1);
        }
        else if (DateOnly.TryParse(QueryStart, out var start) && DateOnly.TryParse(QueryEnd, out var end) && end >= start)
        {
            rangeStart = start;
            rangeEnd = end;
        }
        else
        {
            var today = DateOnly.FromDateTime(DateTime.Today);
            rangeStart = new DateOnly(today.Year, today.Month, 1);
            rangeEnd = rangeStart.AddMonths(1).AddDays(-1);
        }
    }

    private async void HandleScopeChanged(BudgetScope? scope)
    {
        await LoadReportAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task HandleRangeChanged((DateOnly Start, DateOnly End) range)
    {
        rangeStart = range.Start;
        rangeEnd = range.End;

        // Update URL for bookmarking
        Navigation.NavigateTo(
            $"/reports/categories?start={rangeStart:yyyy-MM-dd}&end={rangeEnd:yyyy-MM-dd}",
            replace: true);

        await LoadReportAsync();
    }

    private async Task LoadReportAsync()
    {
        isLoading = true;
        errorMessage = null;
        StateHasChanged();

        try
        {
            var rangeReport = await ApiService.GetCategoryReportByRangeAsync(rangeStart, rangeEnd);
            if (rangeReport != null)
            {
                totalSpending = rangeReport.TotalSpending;
                totalIncome = rangeReport.TotalIncome;
                categoryList = rangeReport.Categories;
                BuildChartSegments();
            }
            else
            {
                totalSpending = null;
                totalIncome = null;
                categoryList = [];
                chartSegments = new List<DonutSegmentData>();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load report: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void BuildChartSegments()
    {
        chartSegments = categoryList
            .Where(c => c.Amount.Amount > 0)
            .OrderByDescending(c => c.Amount.Amount)
            .Select(c => new DonutSegmentData
            {
                Id = c.CategoryId?.ToString() ?? "uncategorized",
                Label = c.CategoryName,
                Value = c.Amount.Amount,
                Percentage = c.Percentage,
                Color = c.CategoryColor ?? "#999999",
                TransactionCount = c.TransactionCount,
                Data = c,
            })
            .ToList();
    }

    private void HandleSegmentClick(DonutSegmentData segment)
    {
        if (segment.Data is CategorySpendingDto category && category.CategoryId.HasValue)
        {
            NavigateToCategory(category.CategoryId);
        }
    }

    private void NavigateToCategory(Guid? categoryId)
    {
        if (categoryId.HasValue)
        {
            Navigation.NavigateTo($"/accounts?categoryId={categoryId}&startDate={rangeStart:yyyy-MM-dd}&endDate={rangeEnd:yyyy-MM-dd}");
        }
    }

    private async Task RetryLoad()
    {
        isRetrying = true;
        StateHasChanged();
        await LoadReportAsync();
        isRetrying = false;
    }

    private void DismissError()
    {
        errorMessage = null;
    }

    /// <inheritdoc/>
    public void Dispose()
    {
        ScopeService.ScopeChanged -= HandleScopeChanged;
    }
}
