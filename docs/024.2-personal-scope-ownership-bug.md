# Feature 024.2: Fix Personal Scope Ownership Filtering Bug

## Status: Complete ✓

## Problem Statement

When creating budget categories under "Personal" scope, the categories are not returned by the API when querying with `scope=Personal`. This is because the query filters for `OwnerUserId IS NULL` when it should be filtering for the current user's ID.

### Root Cause (FOUND)

**The issue is NOT in the repository query logic.** The repository queries are correct:
```csharp
BudgetScope.Personal => query.Where(x => x.Scope == BudgetScope.Personal && x.OwnerUserId == userId)
```

**The actual root cause:** Authentik's `sub` claim provides a 64-character hex string, not a standard GUID:
```
"sub": "2aeb3c500a39985c209121ba8aa440a1254c7533fbe5bf1ee2be8be5a5907637"
```

When `UserContext.UserIdAsGuid` attempted to parse this 64-char hex string as a GUID, `Guid.TryParse()` failed and returned `null`. This caused EF Core to translate `OwnerUserId == null` to `OwnerUserId IS NULL` in SQL.

### Solution

Updated `UserContext.UserIdAsGuid` to handle Authentik's hex format by:
1. First attempting standard GUID parsing (for backwards compatibility)
2. If that fails, checking if the string is a valid hex string of 32+ characters
3. Taking the first 32 hex characters and parsing them as a GUID using format "N"

This creates a **deterministic GUID** from the Authentik sub claim:
```
"2aeb3c500a39985c209121ba8aa440a1..." → 2aeb3c50-0a39-985c-2091-21ba8aa440a1
```

### Observed Behavior

1. User creates a category with scope = "Personal"
2. Category is saved with `OwnerUserId = <user's ID>` (correct)
3. User queries categories with `scope=Personal`
4. Query returns no results because it filters for `OwnerUserId IS NULL`
5. User sees no categories when switching to "Personal" scope

### Expected Behavior

1. User creates a category with scope = "Personal"
2. Category is saved with `OwnerUserId = <user's ID>`
3. User queries categories with `scope=Personal`
4. Query returns categories where `OwnerUserId = <current user's ID>`
5. User sees their personal categories

## Affected Files

- [src/BudgetExperiment.Api/UserContext.cs](../src/BudgetExperiment.Api/UserContext.cs) - Updated `UserIdAsGuid` property
- [tests/BudgetExperiment.Api.Tests/UserContextTests.cs](../tests/BudgetExperiment.Api.Tests/UserContextTests.cs) - Added tests for Authentik format

## Implementation Summary

### Changes Made

1. **UserContext.cs**: Added `ParseUserIdAsGuid()` helper method that:
   - Attempts standard GUID parsing first
   - Falls back to parsing first 32 chars of hex strings (Authentik format)
   - Returns null for invalid formats

2. **UserContextTests.cs**: Added 5 tests:
   - `UserIdAsGuid_WhenUserIdIsValidGuid_ReturnsGuid` - Standard GUID parsing
   - `UserIdAsGuid_WhenAuthentikHexFormat_ReturnsDerivedGuid` - Authentik 64-char hex
   - `UserIdAsGuid_WhenAuthentikHexFormat_ReturnsDeterministicGuid` - Consistency check
   - `UserIdAsGuid_WhenUserIdIsNotValidGuidOrHex_ReturnsNull` - Invalid format
   - `UserIdAsGuid_WhenNotAuthenticated_ReturnsNull` - No user context

## Acceptance Criteria

- [x] Personal scope returns only the current user's personal items
- [x] Shared scope returns shared items visible to all users
- [x] All scope returns both shared items AND current user's personal items
- [x] Existing tests pass (414 tests)
- [x] New tests cover the Authentik hex format scenarios

## Priority

**High** - This was a data visibility bug that prevented users from seeing their own data.

## Discovered

Found during manual testing of Feature 024 (Categorization Rules) on January 17, 2026.

## Resolution

Fixed on January 17, 2026 by updating `UserContext.UserIdAsGuid` to handle Authentik's 64-character hex sub claim format.
