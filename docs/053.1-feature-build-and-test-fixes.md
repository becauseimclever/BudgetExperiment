# Feature 053.1: Build & Test Fixes for Features 051–053
> **Status:** Complete

## Overview

Review of features 051 (AI Assistant Calendar Context), 052 (Performance TTFP/Page Load), and 053 (Reporting & Data Portability) uncovered build-breaking and test-breaking issues. This document catalogs every issue found, its root cause, and the fix applied.

## Problem Statement

After features 051–053 were marked complete, the solution failed to build with **188 compilation errors** concentrated in the Client project. Beyond the build failures, **23 unit tests** also failed due to missing service registrations and interface method stubs.

### Current State (Before Fix)

- `dotnet build` produced 188 errors (all RZ1006/RZ1000 in `ReportCanvas.razor`).
- 23 unit tests failed across `BudgetExperiment.Client.Tests`.
- Features 051 and 052 were correctly implemented and fully tested.
- Feature 053 code was structurally correct but contained Razor-parser-incompatible patterns.

### Target State (After Fix)

- Build succeeds with **0 errors, 0 warnings**.
- All **1994 tests pass** (772 Domain + 491 Application + 431 Client + 300 Api), 1 skipped.

---

## Issues Found & Fixes Applied

### Issue 1: Razor Parser Failure — Escaped Quotes in Interpolated Strings (188 errors)

**File:** `src/BudgetExperiment.Client/Components/Reports/ReportCanvas.razor`

**Root Cause:** The Razor source generator cannot parse escaped quotes `\"` inside interpolated string expressions within `@code` blocks. Code like:

```csharp
$"repeat({grid.GetColumns(\"lg\")}, 1fr)"
```

causes the parser to lose track of string boundaries, fail to find the closing `}` for the `@code` block, and dump all class-level members into `BuildRenderTree` — producing cascading errors for every method, field, and property.

**Fix:** Extract the problematic calls into local variables before the interpolated string:

```csharp
var lgCols = grid.GetColumns("lg");
// then use:
$"repeat({lgCols}, 1fr)"
```

Applied to `GetGridStyle()` (3 calls) and `GetWidgetStyle()` (3 calls).

---

### Issue 2: Razor `@layout` Directive Conflict

**File:** `src/BudgetExperiment.Client/Pages/Reports/CustomReportBuilder.razor`

**Root Cause:** Using `@layout.Name` or `@layout.Id` in Razor markup is interpreted as the `@layout` directive rather than accessing the `layout` variable's properties.

**Fix:** Renamed the variable from `layout` to `savedLayout` throughout the file, and the `Layout` component parameter to `ReportLayout`.

---

### Issue 3: Missing Global Using for Domain.Reports Namespace

**Files:**
- `src/BudgetExperiment.Infrastructure/GlobalUsings.cs`
- `src/BudgetExperiment.Application/GlobalUsings.cs`

**Root Cause:** Feature 053 added `BudgetExperiment.Domain.Reports` namespace with `CustomReportLayout` and related types, but the global using was not added to Infrastructure or Application projects.

**Fix:** Added `global using BudgetExperiment.Domain.Reports;` to both files.

---

### Issue 4: Missing Interface Method Stubs in Test Classes

**Files:**
- `tests/BudgetExperiment.Client.Tests/Pages/Reports/BudgetComparisonReportTests.cs`
- `tests/BudgetExperiment.Client.Tests/Components/Reports/DaySummaryTests.cs`
- `tests/BudgetExperiment.Client.Tests/Components/Reports/CalendarInsightsPanelTests.cs`

**Root Cause:** `IBudgetApiService` grew with 5 new custom report layout methods (`GetCustomReportLayoutsAsync`, `GetCustomReportLayoutAsync`, `CreateCustomReportLayoutAsync`, `UpdateCustomReportLayoutAsync`, `DeleteCustomReportLayoutAsync`), but the `StubBudgetApiService` classes in these 3 test files were not updated.

**Fix:** Added all 5 missing stub method implementations to each test file.

---

### Issue 5: Missing Service Registrations in Test Classes

**Files & Missing Services:**
- `ReportWidgetTests.cs` — missing `ThemeService` + `IAsyncLifetime`
- `WidgetConfigPanelTests.cs` — missing `ThemeService` + `IAsyncLifetime`
- `BudgetComparisonReportTests.cs` — missing `IToastService` + `IExportDownloadService`
- `ExportButtonTests.cs` — missing `using Microsoft.Extensions.DependencyInjection;`

**Root Cause:** New components depend on services (`ThemeService`, `IToastService`, `IExportDownloadService`) that weren't registered in the test DI container. Additionally, `ThemeService` implements `IAsyncDisposable` only, requiring test classes to implement `IAsyncLifetime` for proper cleanup.

**Fix:** Added service registrations in constructors. Added `IAsyncLifetime` with `DisposeAsync` delegation to `ReportWidgetTests` and `WidgetConfigPanelTests`. Added `StubExportDownloadService` inner class to `BudgetComparisonReportTests`.

---

### Issue 6: AreaChart String Parameter Binding

**File:** `src/BudgetExperiment.Client/Components/Charts/AreaChart.razor`

**Root Cause:** String-typed component parameters were passed without `@` prefix (e.g., `AriaLabel="AriaLabel"`), which Blazor treats as a literal string `"AriaLabel"` rather than binding to the `AriaLabel` property.

**Fix:** Changed to `AriaLabel="@AriaLabel"`, `XAxisLabel="@XAxisLabel"`, `YAxisLabel="@YAxisLabel"`, `Interpolation="@Interpolation"`.

---

### Issue 7: Missing XML Doc Param Tag

**File:** `src/BudgetExperiment.Api/Controllers/ExportController.cs`

**Root Cause:** Constructor had a `budgetProgressService` parameter without a corresponding `<param>` XML doc tag, causing an analyzer error.

**Fix:** Added `<param name="budgetProgressService">Budget progress service.</param>`.

---

### Issue 8: Invalid Enum Member Reference

**File:** `tests/BudgetExperiment.Api.Tests/ChatControllerTests.cs`

**Root Cause:** Test referenced `ChatActionType.Unknown` which doesn't exist in the enum.

**Fix:** Changed to `default(ChatActionType)`.

---

## Feature Verification Summary

| Feature | Status | Notes |
|---------|--------|-------|
| 051 — AI Assistant Calendar Context | Verified Complete | All code and tests in place |
| 052 — Performance TTFP/Page Load | Verified Complete | All code and tests in place |
| 053 — Reporting & Data Portability | Verified Complete | Build/test issues fixed in this doc |

---

## Testing Strategy

### Verification

- [x] Full solution build: 0 errors, 0 warnings
- [x] Domain tests: 772 passed
- [x] Application tests: 491 passed
- [x] Client tests: 431 passed, 1 skipped
- [x] Api tests: 300 passed
- [x] Total: 1994 passed, 0 failed

---

## Changelog

| Date | Change | Author |
|------|--------|--------|
| 2025-06-25 | Initial draft — cataloged all 8 issues and fixes | @copilot |
