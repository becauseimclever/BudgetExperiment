# Docker Compose configuration for a second instance of BudgetExperiment
# Can be run alongside the primary instance using different ports and database
#
# Usage:
#   docker compose -f docker-compose.pi.yml -f docker-compose.second.yml up -d
#
# Or run just this instance:
#   docker compose -f docker-compose.second.yml up -d
#
# Example .env file additions:
#   DB_CONNECTION_STRING_2=Host=your-db-server;Port=5432;Database=budgetexperiment2;Username=your-user;Password=your-password

services:
  budgetexperiment-2:
    image: ghcr.io/becauseimclever/budgetexperiment:3
    container_name: budgetexperiment-2
    ports:
      - "5100:8080"
    environment:
      # ASP.NET Core configuration
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:8080
      
      # Database connection (use DB_CONNECTION_STRING_2 for separate DB, or DB_CONNECTION_STRING to share)
      - ConnectionStrings__AppDb=${DB_CONNECTION_STRING_2:-${DB_CONNECTION_STRING}}
      
      # Authentication (Authentik OIDC)
      - Authentication__Authentik__Enabled=${AUTHENTIK_ENABLED_2:-${AUTHENTIK_ENABLED:-false}}
      - Authentication__Authentik__Authority=${AUTHENTIK_AUTHORITY_2:-${AUTHENTIK_AUTHORITY:-}}
      - Authentication__Authentik__Audience=${AUTHENTIK_AUDIENCE_2:-${AUTHENTIK_AUDIENCE:-}}
      - Authentication__Authentik__RequireHttpsMetadata=${AUTHENTIK_REQUIRE_HTTPS_2:-${AUTHENTIK_REQUIRE_HTTPS:-true}}
      
      # Logging
      - Logging__LogLevel__Default=Information
      - Logging__LogLevel__Microsoft.AspNetCore=Warning
      
      # CORS (adjust as needed for production)
      - AllowedHosts=*
    
    restart: unless-stopped
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    
    # Resource limits (adjust based on your Raspberry Pi model)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M
    
    # Network configuration
    networks:
      - budget-network

networks:
  budget-network:
    driver: bridge
